"use strict";(self.webpackChunkying_blog=self.webpackChunkying_blog||[]).push([[681],{9613:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>v});var r=n(9496);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=r.createContext({}),p=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},c=function(e){var t=p(e.components);return r.createElement(l.Provider,{value:t},e.children)},u="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,l=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),u=p(n),d=a,v=u["".concat(l,".").concat(d)]||u[d]||m[d]||o;return n?r.createElement(v,s(s({ref:t},c),{},{components:n})):r.createElement(v,s({ref:t},c))}));function v(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,s=new Array(o);s[0]=d;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i[u]="string"==typeof e?e:a,s[1]=i;for(var p=2;p<o;p++)s[p]=n[p];return r.createElement.apply(null,s)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},5150:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>m,frontMatter:()=>o,metadata:()=>i,toc:()=>p});var r=n(8957),a=(n(9496),n(9613));const o={id:"preview-component-and-router-cache",sidebar_label:"\u9884\u89c8\u7ec4\u4ef6\u548c\u8def\u7531\u7f13\u5b58",title:"\u9884\u89c8\u7ec4\u4ef6\u548c\u8def\u7531\u7f13\u5b58"},s=void 0,i={unversionedId:"ying-chat/preview-component-and-router-cache",id:"ying-chat/preview-component-and-router-cache",title:"\u9884\u89c8\u7ec4\u4ef6\u548c\u8def\u7531\u7f13\u5b58",description:"\u672c\u8282\u6765\u5b9e\u73b0\u56fe\u7247\u548c\u89c6\u9891\u9884\u89c8\u7ec4\u4ef6\u548c\u8def\u7531\u7684\u7f13\u5b58\u3002",source:"@site/docs/ying-chat/18-preview-component-and-router-cache.md",sourceDirName:"ying-chat",slug:"/ying-chat/preview-component-and-router-cache",permalink:"/docs/ying-chat/preview-component-and-router-cache",draft:!1,tags:[],version:"current",sidebarPosition:18,frontMatter:{id:"preview-component-and-router-cache",sidebar_label:"\u9884\u89c8\u7ec4\u4ef6\u548c\u8def\u7531\u7f13\u5b58",title:"\u9884\u89c8\u7ec4\u4ef6\u548c\u8def\u7531\u7f13\u5b58"},sidebar:"yingChat",previous:{title:"\u5ba2\u6237\u7aef\u5bf9\u63a5\u7fa4\u804aapi",permalink:"/docs/ying-chat/docking-message-api"},next:{title:"\u4f7f\u7528socket.io\u5b9e\u73b0\u5373\u65f6\u901a\u8baf",permalink:"/docs/ying-chat/realtime-message-and-socket.io"}},l={},p=[{value:"\u56fe\u7247\u548c\u89c6\u9891\u9884\u89c8\u7ec4\u4ef6",id:"\u56fe\u7247\u548c\u89c6\u9891\u9884\u89c8\u7ec4\u4ef6",level:2},{value:"\u7ec4\u4ef6\u51c6\u5907",id:"\u7ec4\u4ef6\u51c6\u5907",level:3},{value:"\u4f7f\u7528",id:"\u4f7f\u7528",level:3},{value:"\u8def\u7531\u7f13\u5b58\u6dfb\u52a0",id:"\u8def\u7531\u7f13\u5b58\u6dfb\u52a0",level:2},{value:"react-router \u7684\u7f13\u5b58",id:"react-router-\u7684\u7f13\u5b58",level:3},{value:"\u4f1a\u8bdd\u548c\u7fa4\u8be6\u60c5\u9875\u9762\u7f13\u5b58",id:"\u4f1a\u8bdd\u548c\u7fa4\u8be6\u60c5\u9875\u9762\u7f13\u5b58",level:3}],c={toc:p},u="wrapper";function m(e){let{components:t,...o}=e;return(0,a.kt)(u,(0,r.Z)({},c,o,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"\u672c\u8282\u6765\u5b9e\u73b0\u56fe\u7247\u548c\u89c6\u9891\u9884\u89c8\u7ec4\u4ef6\u548c\u8def\u7531\u7684\u7f13\u5b58\u3002"),(0,a.kt)("h2",{id:"\u56fe\u7247\u548c\u89c6\u9891\u9884\u89c8\u7ec4\u4ef6"},"\u56fe\u7247\u548c\u89c6\u9891\u9884\u89c8\u7ec4\u4ef6"),(0,a.kt)("h3",{id:"\u7ec4\u4ef6\u51c6\u5907"},"\u7ec4\u4ef6\u51c6\u5907"),(0,a.kt)("p",null,"\u5728",(0,a.kt)("inlineCode",{parentName:"p"},"stores"),"\u6587\u4ef6\u5939\u91cc\u6dfb\u52a0",(0,a.kt)("inlineCode",{parentName:"p"},"use-preview-store.ts"),"\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="apps/client/src/stores/use-preview-store.ts"',title:'"apps/client/src/stores/use-preview-store.ts"'},"import { create } from 'zustand'\n\ntype PreviewType = 'image' | 'video'\n\ntype PreviewStore = {\n  type: PreviewType\n  url: string\n  open: boolean\n}\n\nexport const usePreview = create<PreviewStore>(() => ({\n  type: 'image',\n  url: '',\n  open: false\n}))\n\nexport const openPreview = (type: PreviewType, url: string) => {\n  usePreview.setState({ open: true, type, url })\n}\n\nexport const closePreview = () => {\n  usePreview.setState({ open: false })\n}\n")),(0,a.kt)("p",null,"\u5bfc\u51fa\u4e00\u4e0b\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="apps/client/src/stores/index.ts"',title:'"apps/client/src/stores/index.ts"'},"// ...\nexport * from './use-preview-store'\n")),(0,a.kt)("p",null,"\u5728",(0,a.kt)("inlineCode",{parentName:"p"},"components"),"\u91cc\u9762\u76f4\u63a5\u6dfb\u52a0",(0,a.kt)("inlineCode",{parentName:"p"},"PreviewModal"),"\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-tsx",metastring:'title="apps/client/src/components/preview-modal.tsx"',title:'"apps/client/src/components/preview-modal.tsx"'},'import { Modal, ModalContent } from \'@nextui-org/react\'\nimport { usePreview, closePreview } from \'@/stores\'\n\nexport const PreviewModal = () => {\n  const { open, url, type } = usePreview()\n\n  return (\n    <Modal\n      isOpen={open}\n      onClose={() => closePreview()}\n      className="bg-transparent"\n      size="full"\n      classNames={{ closeButton: \'top-5 right-5\' }}\n    >\n      <ModalContent className="fc">\n        {type === \'image\' ? (\n          <img src={url} className="max-w-full h-[80%] object-cover" />\n        ) : (\n          <video className="max-w-full h-[80%]" src={url} controls autoPlay />\n        )}\n      </ModalContent>\n    </Modal>\n  )\n}\n')),(0,a.kt)("h3",{id:"\u4f7f\u7528"},"\u4f7f\u7528"),(0,a.kt)("p",null,"\u5728",(0,a.kt)("inlineCode",{parentName:"p"},"App.tsx"),"\u91cc\u4f7f\u7528",(0,a.kt)("inlineCode",{parentName:"p"},"PreviewModal"),"\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-tsx",metastring:'title="apps/client/src/App.tsx"',title:'"apps/client/src/App.tsx"'},'// ...\nimport { PreviewModal } from \'@/components/preview-modal\'\n\nfunction App() {\n  return (\n    <ThemeProvider defaultTheme="dark">\n      <Toaster richColors position="top-center" />\n      <PreviewModal />\n      <RouterProvider router={router}></RouterProvider>\n    </ThemeProvider>\n  )\n}\n\nexport default App\n')),(0,a.kt)("p",null,"\u5728",(0,a.kt)("inlineCode",{parentName:"p"},"message-item.tsx"),"\u91cc\u4f7f\u7528",(0,a.kt)("inlineCode",{parentName:"p"},"openPreview"),"\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-tsx",metastring:'title="apps/client/src/pages/conversation/messages/message-item.tsx"',title:'"apps/client/src/pages/conversation/messages/message-item.tsx"'},"// ...\nimport {\n  // ...\n  openPreview\n} from '@/stores'\n\nconst MessageItem = memo(\n  forwardRef<HTMLDivElement, ChatMessageItemProps>(\n    ({ message }, messageItemRef) => {\n      // ...\n\n      return (\n        {/*  */}\n        {message.type === GroupMessageType.Image && (\n          <Image\n            src={message.file?.url}\n            className=\"w-auto h-[200px] cursor-pointer\"\n            onClick={() => openPreview('image', message.file!.url)}\n          />\n        )}\n\n        {message.type === GroupMessageType.Video && (\n          <Image\n            className=\"w-auto h-[200px] cursor-pointer\"\n            src={message.cover?.url}\n            onClick={() => openPreview('video', message.file!.url)}\n          />\n        )}\n        {/*  */}\n      )\n    }\n  ),\n  (prevProps, nextProps) => {\n    return prevProps.message.id === nextProps.message.id\n  }\n)\n// ...\n")),(0,a.kt)("p",null,"\u6d4b\u8bd5\u4e00\u4e0b\u3002"),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(5115).Z,width:"1920",height:"1080"})),(0,a.kt)("h2",{id:"\u8def\u7531\u7f13\u5b58\u6dfb\u52a0"},"\u8def\u7531\u7f13\u5b58\u6dfb\u52a0"),(0,a.kt)("h3",{id:"react-router-\u7684\u7f13\u5b58"},"react-router \u7684\u7f13\u5b58"),(0,a.kt)("p",null,"\u5148\u5b89\u88c5\u4e00\u4e0b\u4f9d\u8d56\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell",metastring:'title="apps/client"',title:'"apps/client"'},"pnpm i react-freeze\n")),(0,a.kt)("p",null,"\u6dfb\u52a0\u4e00\u4e2a",(0,a.kt)("inlineCode",{parentName:"p"},"KeepAliveOutlet"),"\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-tsx",metastring:'title="apps/client/src/router/keep-alive.tsx"',title:'"apps/client/src/router/keep-alive.tsx"'},"import { ReactElement, useContext, useRef } from 'react'\nimport { Freeze } from 'react-freeze'\nimport { UNSAFE_RouteContext as RouteContext } from 'react-router-dom'\n\nexport const KeepAliveOutlet = () => {\n  const caches = useRef<Record<string, ReactElement>>({})\n\n  const routeContext = useContext(RouteContext)\n  const matchedElement = routeContext.outlet\n  const matchedPath = matchedElement?.props?.match?.pathname\n\n  if (matchedElement && matchedPath) {\n    caches.current[matchedPath] = matchedElement\n  }\n\n  return (\n    <>\n      {Object.entries(caches.current).map(([path, element]) => (\n        <Freeze key={path} freeze={element !== matchedElement}>\n          {element}\n        </Freeze>\n      ))}\n    </>\n  )\n}\n")),(0,a.kt)("p",null,"\u628a\u5148\u524d\u4f7f\u7528\u7684",(0,a.kt)("inlineCode",{parentName:"p"},"react-router-dom"),"\u7684",(0,a.kt)("inlineCode",{parentName:"p"},"Outlet"),"\u5168\u90e8\u6362\u6210",(0,a.kt)("inlineCode",{parentName:"p"},"KeepAliveOutlet"),"\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-tsx",metastring:'title="apps/client/src/components/layout/index.tsx"',title:'"apps/client/src/components/layout/index.tsx"'},'// ...\nimport { KeepAliveOutlet } from \'@/router/keep-alive\'\n\nexport const AppLayout = () => {\n  return useAuthRoute(\n    <div className="h-full flex flex-row">\n      <NavSidebar />\n\n      <main className="h-full flex-1">\n        <KeepAliveOutlet />\n      </main>\n    </div>\n  )\n}\n')),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-tsx",metastring:'title="apps/client/src/pages/contact/index.tsx"',title:'"apps/client/src/pages/contact/index.tsx"'},'import { KeepAliveOutlet } from \'@/router/keep-alive\'\n// ...\n\nexport const ContactPage = () => {\n  return (\n    <div className="h-full flex flex-row">\n      <Sidebar />\n\n      <main className="flex-1">\n        <KeepAliveOutlet />\n      </main>\n    </div>\n  )\n}\n')),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-tsx",metastring:'title="apps/client/src/pages/conversation/index.tsx"',title:'"apps/client/src/pages/conversation/index.tsx"'},'import { KeepAliveOutlet } from \'@/router/keep-alive\'\n// ...\n\nexport const ConversationPage = () => {\n  return (\n    <ConversationProvider>\n      <div className="h-full flex flex-row">\n        <Sidebar />\n\n        <main className="flex-1">\n          <KeepAliveOutlet />\n        </main>\n      </div>\n    </ConversationProvider>\n  )\n}\n')),(0,a.kt)("p",null,"\u6d4b\u8bd5\u4e00\u4e0b\u3002"),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(1803).Z,width:"1920",height:"1080"})),(0,a.kt)("h3",{id:"\u4f1a\u8bdd\u548c\u7fa4\u8be6\u60c5\u9875\u9762\u7f13\u5b58"},"\u4f1a\u8bdd\u548c\u7fa4\u8be6\u60c5\u9875\u9762\u7f13\u5b58"),(0,a.kt)("p",null,"\u867d\u7136\u8def\u7531\u9875\u9762\u7684\u7f13\u5b58\u6dfb\u52a0\u4e0a\u4e86\uff0c\u4f46\u662f\u70b9\u51fb",(0,a.kt)("inlineCode",{parentName:"p"},"NavSidebar"),"\u7684\u8df3\u8f6c\u4e0d\u4f1a\u8bb0\u5f55\u4e0a\u6b21\u8bbf\u95ee\u7684\u9875\u9762\uff0c\u63a5\u4e0b\u6765\u5728\u5168\u5c40\u72b6\u6001\u91cc\u6dfb\u52a0\u4e00\u4e0b\u3002"),(0,a.kt)("p",null,"\u4fee\u6539\u4e00\u4e0b",(0,a.kt)("inlineCode",{parentName:"p"},"router"),"\u4e0b\u7684",(0,a.kt)("inlineCode",{parentName:"p"},"index.tsx"),"\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-tsx",metastring:'title="apps/client/src/router/index.tsx"',title:'"apps/client/src/router/index.tsx"'},"import { createContext, useEffect } from 'react'\nimport { useLocation, useRoutes } from 'react-router-dom'\nimport { routes } from './routes'\n\ntype keyType = '/contact' | '/conversation'\ntype CacheType = Record<keyType, string>\n\nconst routeKeyCache: CacheType = {\n  '/contact': '/contact',\n  '/conversation': '/conversation'\n}\n\nconst setRouteKeyCache = (key: keyType, value: string) => {\n  routeKeyCache[key] = value\n}\n\ntype RouterContextType = {\n  routeKeyCache: CacheType\n}\n\nexport const RouterContext = createContext<RouterContextType>({\n  routeKeyCache\n})\n\nexport const RouterProvider = () => {\n  const routesElements = useRoutes(routes)\n  const { pathname } = useLocation()\n\n  useEffect(() => {\n    if (pathname.startsWith('/contact')) {\n      setRouteKeyCache('/contact', pathname)\n    }\n\n    if (pathname.startsWith('/conversation')) {\n      setRouteKeyCache('/conversation', pathname)\n    }\n  }, [pathname])\n\n  return (\n    <RouterContext.Provider\n      value={{\n        routeKeyCache\n      }}\n    >\n      {routesElements}\n    </RouterContext.Provider>\n  )\n}\n")),(0,a.kt)("p",null,"\u518d\u6dfb\u52a0\u4e00\u4e2a",(0,a.kt)("inlineCode",{parentName:"p"},"useRouterContext"),"\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="apps/client/src/router/use-router-context.ts"',title:'"apps/client/src/router/use-router-context.ts"'},"import { useContext } from 'react'\nimport { RouterContext } from '.'\n\nexport const useRouterContext = () => {\n  return useContext(RouterContext)\n}\n")),(0,a.kt)("p",null,"\u6539\u53d8\u4e00\u4e0b\u8def\u7531\u7684\u5f15\u5165\u65b9\u5f0f\uff0c\u4fee\u6539",(0,a.kt)("inlineCode",{parentName:"p"},"App.tsx"),"\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-tsx",metastring:'title="apps/client/src/App.tsx"',title:'"apps/client/src/App.tsx"'},"import { BrowserRouter } from 'react-router-dom'\nimport { RouterProvider } from '@/router'\n// ...\n\nfunction App() {\n  return (\n    <ThemeProvider defaultTheme=\"dark\">\n      <Toaster richColors position=\"top-center\" />\n      <PreviewModal />\n      <BrowserRouter>\n        <RouterProvider />\n      </BrowserRouter>\n    </ThemeProvider>\n  )\n}\n\nexport default App\n")),(0,a.kt)("p",null,"\u6700\u540e\u4fee\u6539\u4e00\u4e0b",(0,a.kt)("inlineCode",{parentName:"p"},"NavSidebar"),"\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-tsx",metastring:'title="apps/client/src/components/layout/nav-sidebar.tsx"',title:'"apps/client/src/components/layout/nav-sidebar.tsx"'},"// ...\nimport { useRouterContext } from '@/router/use-router-context'\n\nexport const NavSidebar = () => {\n  // ...\n  const { routeKeyCache } = useRouterContext()\n\n  // ...\n\n  return (\n    <div className=\"flex flex-col gap-4 items-center w-[72px] py-4 bg-content1\">\n      <div className=\"flex-1 flex flex-col gap-2\">\n        <div\n          className={cn(\n            `fc text-xl w-[48px] h-[48px] cursor-pointer rounded-full transition-all duration-700`,\n            'hover:rounded-2xl text-foreground bg-default',\n            pathname.startsWith('/conversation') && 'rounded-2xl bg-primary'\n          )}\n          onClick={() => {\n            const cacheRoute = routeKeyCache['/conversation']\n            if (cacheRoute) {\n              navigate(cacheRoute, { replace: true })\n            } else {\n              navigate('/conversation', { replace: true })\n            }\n          }}\n        >\n          <MessageSquare />\n        </div>\n        <div\n          className={cn(\n            `fc text-xl w-[48px] h-[48px] cursor-pointer rounded-full transition-all duration-700`,\n            'hover:rounded-2xl text-foreground bg-default',\n            pathname.startsWith('/contact') && 'rounded-2xl bg-primary'\n          )}\n          onClick={() => {\n            const cacheRoute = routeKeyCache['/contact']\n            if (cacheRoute) {\n              navigate(cacheRoute, { replace: true })\n            } else {\n              navigate('/contact', { replace: true })\n            }\n          }}\n        >\n          <Users />\n        </div>\n      </div>\n      {/*  */}\n    </div>\n  )\n}\n")),(0,a.kt)("p",null,"\u7fa4\u8be6\u60c5\u9875\u9762\u8fd8\u6709\u4e00\u4e2a\u70b9\u51fb\u4e8b\u4ef6\u672a\u6dfb\u52a0\uff0c\u987a\u4fbf\u52a0\u4e00\u4e0b\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-tsx",metastring:'title="apps/client/src/pages/contact/contact-detail.tsx"',title:'"apps/client/src/pages/contact/contact-detail.tsx"'},'// ...\nimport {\n  // ...\n  useNavigate\n} from \'react-router-dom\'\n// ...\n\nexport const ContactDetail = () => {\n  // ...\n  const navigate = useNavigate()\n  // ...\n\n  const Detail = () => {\n    // ...\n\n    return (\n      <div className="w-[50%] h-[50%]">\n        <div className="flex items-center">\n          {/*  */}\n          <Button\n            color="primary"\n            isIconOnly\n            className="rounded-full w-16 h-16"\n            onClick={() => {\n              navigate(`/conversation/group/${data.id}`)\n            }}\n          >\n            <MessageSquare size={30} />\n          </Button>\n        </div>\n\n        {/*  */}\n      </div>\n    )\n  }\n\n  // ...\n}\n')),(0,a.kt)("p",null,"\u6574\u4f53\u6d4b\u8bd5\u4e00\u4e0b\u3002"),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(7586).Z,width:"1920",height:"1080"})),(0,a.kt)("p",null,"\u90a3\u4e48\u672c\u8282\u5230\u6b64\u7ed3\u675f\u3002"))}m.isMDXComponent=!0},5115:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/01-76374e51ac920be531b050d67fc669a1.gif"},1803:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/02-96596a09d61448c224ab962330590543.gif"},7586:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/03-2ed8f659e11049d1eb8a235686a2565e.gif"}}]);