"use strict";(self.webpackChunkying_blog=self.webpackChunkying_blog||[]).push([[6623],{5989:(r,n,e)=>{e.r(n),e.d(n,{assets:()=>d,contentTitle:()=>a,default:()=>p,frontMatter:()=>o,metadata:()=>i,toc:()=>l});var s=e(3274),t=e(9128);const o={id:"update-userinfo",sidebar_label:"\u4fee\u6539\u7528\u6237\u4fe1\u606f\u529f\u80fd\u6dfb\u52a0",title:"\u4fee\u6539\u7528\u6237\u4fe1\u606f\u529f\u80fd\u6dfb\u52a0"},a=void 0,i={id:"ying-chat/update-userinfo",title:"\u4fee\u6539\u7528\u6237\u4fe1\u606f\u529f\u80fd\u6dfb\u52a0",description:"\u672c\u8282\u6765\u5b9e\u73b0\u66f4\u65b0\u7528\u6237\u4fe1\u606f\u7684\u6574\u4e2a\u529f\u80fd\u3002",source:"@site/docs/ying-chat/12-update-userinfo.md",sourceDirName:"ying-chat",slug:"/ying-chat/update-userinfo",permalink:"/docs/ying-chat/update-userinfo",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:12,frontMatter:{id:"update-userinfo",sidebar_label:"\u4fee\u6539\u7528\u6237\u4fe1\u606f\u529f\u80fd\u6dfb\u52a0",title:"\u4fee\u6539\u7528\u6237\u4fe1\u606f\u529f\u80fd\u6dfb\u52a0"},sidebar:"yingChat",previous:{title:"\u524d\u7aef\u5bf9\u63a5\u767b\u5f55\u63a5\u53e3",permalink:"/docs/ying-chat/docking-login-api"},next:{title:"\u7528\u6237\u5934\u50cf\u548c\u96c6\u6210MinIO",permalink:"/docs/ying-chat/user-avatar-and-integrated-minio"}},d={},l=[{value:"\u66f4\u65b0\u7528\u6237\u4fe1\u606f\u63a5\u53e3",id:"\u66f4\u65b0\u7528\u6237\u4fe1\u606f\u63a5\u53e3",level:2},{value:"\u5ba2\u6237\u7aef\u5bf9\u63a5",id:"\u5ba2\u6237\u7aef\u5bf9\u63a5",level:2},{value:"\u63a5\u53e3\u51c6\u5907",id:"\u63a5\u53e3\u51c6\u5907",level:3},{value:"\u4fee\u6539\u7528\u6237\u4fe1\u606f\u5f39\u7a97\u7f16\u5199",id:"\u4fee\u6539\u7528\u6237\u4fe1\u606f\u5f39\u7a97\u7f16\u5199",level:3},{value:"\u5f15\u5165",id:"\u5f15\u5165",level:3}];function c(r){const n={code:"code",h2:"h2",h3:"h3",img:"img",p:"p",pre:"pre",...(0,t.R)(),...r.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.p,{children:"\u672c\u8282\u6765\u5b9e\u73b0\u66f4\u65b0\u7528\u6237\u4fe1\u606f\u7684\u6574\u4e2a\u529f\u80fd\u3002"}),"\n",(0,s.jsx)(n.h2,{id:"\u66f4\u65b0\u7528\u6237\u4fe1\u606f\u63a5\u53e3",children:"\u66f4\u65b0\u7528\u6237\u4fe1\u606f\u63a5\u53e3"}),"\n",(0,s.jsxs)(n.p,{children:["\u5148\u6dfb\u52a0\u4e00\u4e2a ",(0,s.jsx)(n.code,{children:"UpdateUserDto"}),"\u3002"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="packages/shared/src/dto/user.dto.ts"',children:"import { IsOptional, MaxLength, MinLength } from 'class-validator'\r\n\r\nexport class UpdateUserDto {\r\n  @MinLength(6)\r\n  @MaxLength(20)\r\n  @IsOptional()\r\n  username?: string\r\n\r\n  @MinLength(2)\r\n  @MaxLength(20)\r\n  @IsOptional()\r\n  nickname?: string\r\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u5728",(0,s.jsx)(n.code,{children:"index.ts"}),"\u91cc\u9762\u5bfc\u51fa\u3002"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="packages/shared/src/dto/index.ts"',children:"// ...\r\nexport * from './user.dto'\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u5728",(0,s.jsx)(n.code,{children:"UserService"}),"\u91cc\u5b9e\u73b0",(0,s.jsx)(n.code,{children:"updateUserInfo"}),"\u51fd\u6570\u53bb\u66f4\u65b0\u7528\u6237\u4fe1\u606f\uff0c\u524d\u9762\u5224\u65ad\u4e00\u4e0b\u7528\u6237\u7684\u767b\u5f55\u540d\u662f\u5426\u552f\u4e00\u5c31\u597d\u3002"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="apps/server/src/modules/user/user.service.ts"',children:"// ...\r\nimport { UpdateUserDto } from '@ying-chat/shared'\r\n\r\n@Injectable()\r\nexport class UserService {\r\n  // ...\r\n\r\n  async updateUserInfo(userId: number, updateUserDto: UpdateUserDto) {\r\n    if (updateUserDto.username) {\r\n      const user = await this.userRepository.findOne({\r\n        where: { username: updateUserDto.username }\r\n      })\r\n      if (user && user.id !== userId) {\r\n        throw new HttpException(\r\n          'username already exists',\r\n          HttpStatus.NOT_ACCEPTABLE\r\n        )\r\n      }\r\n    }\r\n\r\n    await this.userRepository.update({ id: userId }, updateUserDto)\r\n  }\r\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u5728",(0,s.jsx)(n.code,{children:"UserController"}),"\u91cc\u6dfb\u52a0\u66f4\u65b0\u7528\u6237\u4fe1\u606f\u63a5\u53e3\u3002"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="apps/server/src/modules/user/user.controller.ts"',children:"// ...\r\nimport {\r\n  // ...\r\n  Post,\r\n  Req,\r\n  Body\r\n} from '@nestjs/common'\r\nimport { UpdateUserDto } from '@ying-chat/shared'\r\n// ...\r\nexport class UserController {\r\n  // ...\r\n\r\n  @ApiOperation({\r\n    summary: 'updateUserInfo'\r\n  })\r\n  @Post()\r\n  updateUserInfo(\r\n    @Req() request: Request,\r\n    @Body() updateUserDto: UpdateUserDto\r\n  ) {\r\n    return this.userService.updateUserInfo(request.userId, updateUserDto)\r\n  }\r\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"\u5ba2\u6237\u7aef\u5bf9\u63a5",children:"\u5ba2\u6237\u7aef\u5bf9\u63a5"}),"\n",(0,s.jsx)(n.h3,{id:"\u63a5\u53e3\u51c6\u5907",children:"\u63a5\u53e3\u51c6\u5907"}),"\n",(0,s.jsxs)(n.p,{children:["\u5728",(0,s.jsx)(n.code,{children:"api"}),"\u6587\u4ef6\u5939\u4e0b\u65b0\u5efa\u4e00\u4e2a",(0,s.jsx)(n.code,{children:"user.ts"}),"\uff0c\u628a\u66f4\u65b0\u7528\u6237\u4fe1\u606f\u548c\u83b7\u53d6\u7528\u6237\u4fe1\u606f\u63a5\u53e3\u90fd\u52a0\u4e0a\u3002"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="apps/client/src/api/user.ts"',children:"import { UpdateUserDto, UserVo } from '@ying-chat/shared'\r\nimport { request } from './request'\r\n\r\nexport function getUserInfo(): Promise<UserVo> {\r\n  return request.get('/user')\r\n}\r\n\r\nexport function updateUserInfo(updateUserInfoDto: UpdateUserDto) {\r\n  return request.post('/user', updateUserInfoDto)\r\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u5728",(0,s.jsx)(n.code,{children:"index.ts"}),"\u5bfc\u51fa\u4e00\u4e0b\u3002"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="apps/client/src/api/index.ts"',children:"import * as authApi from './auth'\r\nimport * as userApi from './user' // +\r\n\r\nexport {\r\n  authApi,\r\n  userApi // +\r\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"\u4fee\u6539\u7528\u6237\u4fe1\u606f\u5f39\u7a97\u7f16\u5199",children:"\u4fee\u6539\u7528\u6237\u4fe1\u606f\u5f39\u7a97\u7f16\u5199"}),"\n",(0,s.jsxs)(n.p,{children:["\u5728",(0,s.jsx)(n.code,{children:"components"}),"\u4e0b\u65b0\u5efa\u4e00\u4e2a",(0,s.jsx)(n.code,{children:"modals"}),"\u6587\u4ef6\u5939\uff0c\u7136\u540e\u6dfb\u52a0\u4e00\u4e2a",(0,s.jsx)(n.code,{children:"user-info-modal.tsx"}),"\u3002"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-tsx",metastring:'title="apps/client/src/components/modals/user-info-modal.tsx"',children:"import {\r\n  Button,\r\n  Input,\r\n  Modal,\r\n  ModalBody,\r\n  ModalContent,\r\n  ModalFooter,\r\n  ModalHeader\r\n} from '@nextui-org/react'\r\nimport { useState } from 'react'\r\nimport { useForm } from 'react-hook-form'\r\nimport { classValidatorResolver } from '@hookform/resolvers/class-validator'\r\nimport { toast } from 'sonner'\r\nimport { UpdateUserDto } from '@ying-chat/shared'\r\nimport { userApi } from '@/api'\r\n\r\ntype UserInfoModalProps = {\r\n  open: boolean\r\n  close: () => void\r\n  confirmSuccess?: () => void\r\n  initialValues: UpdateUserDto\r\n}\r\n\r\nconst resolver = classValidatorResolver(UpdateUserDto)\r\n\r\nexport const UserInfoModal = ({\r\n  open,\r\n  close,\r\n  confirmSuccess,\r\n  initialValues\r\n}: UserInfoModalProps) => {\r\n  const {\r\n    register,\r\n    handleSubmit,\r\n    formState: { errors }\r\n  } = useForm<UpdateUserDto>({\r\n    resolver\r\n  })\r\n  const [confirmLoading, setConfirmLoading] = useState(false)\r\n\r\n  const onFinish = async (values: UpdateUserDto) => {\r\n    try {\r\n      setConfirmLoading(true)\r\n      await userApi.updateUserInfo(values)\r\n      toast.success('update user info successfully!')\r\n      close()\r\n      confirmSuccess && confirmSuccess()\r\n    } catch {\r\n    } finally {\r\n      setConfirmLoading(false)\r\n    }\r\n  }\r\n\r\n  return (\r\n    <Modal isOpen={open} onClose={close} isDismissable={false}>\r\n      <ModalContent>\r\n        {onClose => (\r\n          <>\r\n            <ModalHeader className=\"flex flex-col gap-1\">User Info</ModalHeader>\r\n            <form onSubmit={handleSubmit(onFinish)}>\r\n              <ModalBody>\r\n                <Input\r\n                  label=\"Username\"\r\n                  maxLength={20}\r\n                  defaultValue={initialValues.username}\r\n                  isInvalid={Boolean(errors.username)}\r\n                  errorMessage={errors.username?.message}\r\n                  {...register('username')}\r\n                />\r\n                <Input\r\n                  label=\"Nickname\"\r\n                  maxLength={20}\r\n                  defaultValue={initialValues.nickname}\r\n                  isInvalid={Boolean(errors.nickname)}\r\n                  errorMessage={errors.nickname?.message}\r\n                  {...register('nickname')}\r\n                />\r\n              </ModalBody>\r\n              <ModalFooter>\r\n                <Button\r\n                  color=\"danger\"\r\n                  variant=\"ghost\"\r\n                  isDisabled={confirmLoading}\r\n                  onPress={onClose}\r\n                >\r\n                  Close\r\n                </Button>\r\n                <Button\r\n                  color=\"primary\"\r\n                  isLoading={confirmLoading}\r\n                  type=\"submit\"\r\n                >\r\n                  Update\r\n                </Button>\r\n              </ModalFooter>\r\n            </form>\r\n          </>\r\n        )}\r\n      </ModalContent>\r\n    </Modal>\r\n  )\r\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u65b0\u5efa\u4e00\u4e2a",(0,s.jsx)(n.code,{children:"index.ts"}),"\u5bfc\u51fa\u3002"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="apps/client/src/components/modals/index.ts"',children:"export * from './user-info-modal'\n"})}),"\n",(0,s.jsx)(n.h3,{id:"\u5f15\u5165",children:"\u5f15\u5165"}),"\n",(0,s.jsxs)(n.p,{children:["\u5728",(0,s.jsx)(n.code,{children:"NavSidebar"}),"\u4e2d\u5f15\u5165"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-tsx",metastring:'title="apps/client/src/components/layout/nav-sidebar.tsx"',children:"// ...\r\nimport { useMemo, useState } from 'react'\r\nimport {\r\n  // ...\r\n  setUserInfo\r\n} from '@/stores'\r\nimport { UserInfoModal } from '@/components/modals'\r\nimport { userApi } from '@/api'\r\n\r\nexport const NavSidebar = () => {\r\n  // ...\r\n\r\n  const [openUserModal, setOpenUserModal] = useState(false)\r\n  const userModalInitialValues = useMemo(() => {\r\n    return {\r\n      username: userInfo?.username || '',\r\n      nickname: userInfo?.nickname || ''\r\n    }\r\n  }, [userInfo])\r\n\r\n  const getUserInfo = async () => {\r\n    try {\r\n      const newUserInfo = await userApi.getUserInfo()\r\n      setUserInfo(newUserInfo)\r\n    } catch {}\r\n  }\r\n\r\n  return (\r\n    <div className=\"flex flex-col gap-4 items-center w-[72px] py-4 bg-content1\">\r\n      {/*  */}\r\n\r\n      <Dropdown placement=\"top-start\" showArrow>\r\n        {/*  */}\r\n        <DropdownMenu\r\n          aria-label=\"Profile Actions\"\r\n          disabledKeys={['profile']}\r\n          variant=\"flat\"\r\n        >\r\n          {/*  */}\r\n\r\n          <DropdownSection showDivider>\r\n            <DropdownItem\r\n              key=\"user-info\"\r\n              startContent={<UserRound className=\"w-5 h-5\" />}\r\n              onClick={() => {\r\n                setOpenUserModal(true)\r\n              }}\r\n            >\r\n              User Info\r\n            </DropdownItem>\r\n            {/*  */}\r\n          </DropdownSection>\r\n\r\n          {/*  */}\r\n        </DropdownMenu>\r\n      </Dropdown>\r\n\r\n      <UserInfoModal\r\n        open={openUserModal}\r\n        close={() => setOpenUserModal(false)}\r\n        confirmSuccess={getUserInfo}\r\n        initialValues={userModalInitialValues}\r\n      />\r\n    </div>\r\n  )\r\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u8c03\u8bd5\u4e00\u4e0b\u3002"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:e(3064).A+"",width:"1920",height:"1080"})}),"\n",(0,s.jsx)(n.p,{children:"\u672c\u8282\u5230\u6b64\u7ed3\u675f\u3002"})]})}function p(r={}){const{wrapper:n}={...(0,t.R)(),...r.components};return n?(0,s.jsx)(n,{...r,children:(0,s.jsx)(c,{...r})}):c(r)}},3064:(r,n,e)=>{e.d(n,{A:()=>s});const s=e.p+"assets/images/01-3b84498cbf025e490804adde7dcb7033.gif"},9128:(r,n,e)=>{e.d(n,{R:()=>a,x:()=>i});var s=e(9474);const t={},o=s.createContext(t);function a(r){const n=s.useContext(o);return s.useMemo((function(){return"function"==typeof r?r(n):{...n,...r}}),[n,r])}function i(r){let n;return n=r.disableParentContext?"function"==typeof r.components?r.components(t):r.components||t:a(r.components),s.createElement(o.Provider,{value:n},r.children)}}}]);