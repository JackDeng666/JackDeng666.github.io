"use strict";(self.webpackChunkying_blog=self.webpackChunkying_blog||[]).push([[3708],{2517:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>a,contentTitle:()=>o,default:()=>p,frontMatter:()=>i,metadata:()=>c,toc:()=>l});var s=n(3274),t=n(9128);const i={id:"login-and-auth-api",sidebar_label:"\u767b\u5f55\u4e0e\u9274\u6743\u5b9e\u73b0",title:"\u767b\u5f55\u4e0e\u9274\u6743\u5b9e\u73b0"},o=void 0,c={id:"ying-chat/login-and-auth-api",title:"\u767b\u5f55\u4e0e\u9274\u6743\u5b9e\u73b0",description:"\u672c\u8282\u6211\u4eec\u5c06\u6765\u5b9e\u73b0\u767b\u5f55\u4e0e\u9274\u6743\u7684\u63a5\u53e3\u903b\u8f91\u3002",source:"@site/docs/ying-chat/10-login-and-auth-api.md",sourceDirName:"ying-chat",slug:"/ying-chat/login-and-auth-api",permalink:"/docs/ying-chat/login-and-auth-api",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:10,frontMatter:{id:"login-and-auth-api",sidebar_label:"\u767b\u5f55\u4e0e\u9274\u6743\u5b9e\u73b0",title:"\u767b\u5f55\u4e0e\u9274\u6743\u5b9e\u73b0"},sidebar:"yingChat",previous:{title:"\u5bf9\u63a5\u6ce8\u518c\u63a5\u53e3",permalink:"/docs/ying-chat/docking-register-api"},next:{title:"\u524d\u7aef\u5bf9\u63a5\u767b\u5f55\u63a5\u53e3",permalink:"/docs/ying-chat/docking-login-api"}},a={},l=[{value:"\u767b\u5f55\u63a5\u53e3\u5b9e\u73b0",id:"\u767b\u5f55\u63a5\u53e3\u5b9e\u73b0",level:2},{value:"\u6d41\u7a0b\u56fe",id:"\u6d41\u7a0b\u56fe",level:3},{value:"\u9a8c\u8bc1\u7801\u83b7\u53d6\u63a5\u53e3",id:"\u9a8c\u8bc1\u7801\u83b7\u53d6\u63a5\u53e3",level:3},{value:"\u767b\u5f55\u903b\u8f91\u5b9e\u73b0",id:"\u767b\u5f55\u903b\u8f91\u5b9e\u73b0",level:3},{value:"jwt \u5b9e\u73b0\u9274\u6743",id:"jwt-\u5b9e\u73b0\u9274\u6743",level:2},{value:"\u767b\u5f55\u8fd4\u56de token",id:"\u767b\u5f55\u8fd4\u56de-token",level:3},{value:"\u7981\u6b62\u7528\u6237\u5b9e\u4f53\u8fd4\u56de\u5bc6\u7801",id:"\u7981\u6b62\u7528\u6237\u5b9e\u4f53\u8fd4\u56de\u5bc6\u7801",level:3},{value:"\u6388\u6743\u5b88\u536b\u6dfb\u52a0",id:"\u6388\u6743\u5b88\u536b\u6dfb\u52a0",level:3},{value:"\u7528\u6237\u4fe1\u606f\u63a5\u53e3",id:"\u7528\u6237\u4fe1\u606f\u63a5\u53e3",level:2},{value:"\u9000\u51fa\u767b\u5f55\u63a5\u53e3",id:"\u9000\u51fa\u767b\u5f55\u63a5\u53e3",level:2}];function d(e){const r={code:"code",h2:"h2",h3:"h3",img:"img",p:"p",pre:"pre",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(r.p,{children:"\u672c\u8282\u6211\u4eec\u5c06\u6765\u5b9e\u73b0\u767b\u5f55\u4e0e\u9274\u6743\u7684\u63a5\u53e3\u903b\u8f91\u3002"}),"\n",(0,s.jsx)(r.h2,{id:"\u767b\u5f55\u63a5\u53e3\u5b9e\u73b0",children:"\u767b\u5f55\u63a5\u53e3\u5b9e\u73b0"}),"\n",(0,s.jsx)(r.h3,{id:"\u6d41\u7a0b\u56fe",children:"\u6d41\u7a0b\u56fe"}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)(r.img,{src:n(8917).A+"",width:"857",height:"710"})}),"\n",(0,s.jsx)(r.h3,{id:"\u9a8c\u8bc1\u7801\u83b7\u53d6\u63a5\u53e3",children:"\u9a8c\u8bc1\u7801\u83b7\u53d6\u63a5\u53e3"}),"\n",(0,s.jsx)(r.p,{children:"\u6839\u636e\u6d41\u7a0b\u56fe\u6211\u4eec\u5148\u8981\u5b9e\u73b0\u4e00\u4e2a\u83b7\u53d6\u9a8c\u8bc1\u7801\u63a5\u53e3\u3002"}),"\n",(0,s.jsxs)(r.p,{children:["\u5728\u670d\u52a1\u7aef\u6dfb\u52a0 ",(0,s.jsx)(r.code,{children:"svg-captcha"})," \u4f9d\u8d56\uff0c\u63a5\u4e0b\u6765\u5c06\u7528\u8fd9\u4e2a\u5e93\u6765\u751f\u6210\u9a8c\u8bc1\u7801\u7684 SVG \u56fe\u3002"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-shell",metastring:'title="apps/server"',children:"pnpm i svg-captcha\n"})}),"\n",(0,s.jsxs)(r.p,{children:["\u5148\u5728 ",(0,s.jsx)(r.code,{children:"redis"})," \u6a21\u5757\u52a0\u4e0a\u767b\u5f55\u7801\u7684\u5e38\u91cf"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",metastring:'title="apps/server/src/modules/redis/constant.ts"',children:"// ...\r\n\r\nexport const RedisKey = {\r\n  RegisterCode: 'register-code:',\r\n  LoginCode: 'login-code:'\r\n}\n"})}),"\n",(0,s.jsxs)(r.p,{children:["\u5728 ",(0,s.jsx)(r.code,{children:"AuthService"})," \u5b9e\u73b0\u4e00\u4e2a ",(0,s.jsx)(r.code,{children:"getCaptcha"})," \u51fd\u6570\uff0c\u6b64\u51fd\u6570\u63a5\u53d7\u4e00\u4e2a ",(0,s.jsx)(r.code,{children:"uid"})," \u4f5c\u4e3a key \u5b58\u8fdb redis\uff0c\u8fd9\u4e2a uid \u5c06\u662f\u5ba2\u6237\u7aef\u4f20\u8fc7\u6765\u7684\u552f\u4e00\u7801\uff0c\u6700\u540e\u8fd4\u56de\u4e00\u4e2a svg \u7684\u5b57\u7b26\u4e32\u3002"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",metastring:'title="apps/server/src/modules/user/auth.service.ts"',children:"// ...\r\nimport { create } from 'svg-captcha'\r\n\r\n@Injectable()\r\nexport class AuthService {\r\n  // ...\r\n\r\n  async getCaptcha(uid: string) {\r\n    const newCaptcha = create({ width: 100, height: 35, noise: 4 })\r\n    await this.redisClient.set(RedisKey.LoginCode + uid, newCaptcha.text, {\r\n      EX: 3 * 60\r\n    })\r\n    return newCaptcha.data\r\n  }\r\n}\n"})}),"\n",(0,s.jsxs)(r.p,{children:["\u5728 ",(0,s.jsx)(r.code,{children:"AuthController"})," \u91cc\u52a0\u4e0a\u9a8c\u8bc1\u7801\u63a5\u53e3\uff0c\u8c03\u7528 ",(0,s.jsx)(r.code,{children:"getCaptcha"}),"\uff0c \u7528 ",(0,s.jsx)(r.code,{children:"Response"})," \u628a svg \u5b57\u7b26\u76f4\u63a5\u4ee5\u6587\u4ef6\u6d41\u7684\u65b9\u5f0f\u8fd4\u56de\u7ed9\u524d\u7aef\u3002"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",metastring:'title="apps/server/src/modules/user/auth.controller.ts"',children:"// ...\r\nimport { Body, Controller, Get, Post, Query, Res } from '@nestjs/common'\r\nimport { Response } from 'express'\r\n\r\n@ApiTags('auth')\r\n@Controller('auth')\r\nexport class AuthController {\r\n  // ...\r\n\r\n  @ApiOperation({\r\n    summary: 'catpcha'\r\n  })\r\n  @Get('/catpcha')\r\n  async getCaptcha(@Query('uid') uid: string, @Res() res: Response) {\r\n    res.send(await this.authService.getCaptcha(uid))\r\n  }\r\n}\n"})}),"\n",(0,s.jsx)(r.h3,{id:"\u767b\u5f55\u903b\u8f91\u5b9e\u73b0",children:"\u767b\u5f55\u903b\u8f91\u5b9e\u73b0"}),"\n",(0,s.jsxs)(r.p,{children:["\u5728 ",(0,s.jsx)(r.code,{children:"shared"})," \u5305\u91cc\u6dfb\u52a0\u4e00\u4e2a ",(0,s.jsx)(r.code,{children:"LoginDto"}),"\u3002"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",metastring:'title="package/shared/src/dto/auth.dto.ts"',children:"// ...\r\n\r\nexport class LoginDto {\r\n  @IsNotEmpty()\r\n  loginName: string\r\n\r\n  @Matches(/^(?=.*[0-9])(?=.*[A-Z])(?=.*[a-z])(?=.*[!@#$%^&*;',.])/, {\r\n    message: `password must contain digits, lowercase letters, uppercase letters, and special symbols[!@#$%^&*;',.]`\r\n  })\r\n  @IsNotEmpty()\r\n  password: string\r\n\r\n  @Length(4)\r\n  @IsNotEmpty()\r\n  code: string\r\n\r\n  @IsNotEmpty()\r\n  uid: string\r\n}\n"})}),"\n",(0,s.jsxs)(r.p,{children:["\u5728 ",(0,s.jsx)(r.code,{children:"AuthService"})," \u91cc\u9762\u6dfb\u52a0 ",(0,s.jsx)(r.code,{children:"login"})," \u51fd\u6570\uff0c\u5b8c\u6210\u767b\u5f55\u7684\u68c0\u9a8c\u903b\u8f91\uff0c\u5269\u4e0b\u7684 token \u751f\u6210\u540e\u9762\u518d\u5199\u3002"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",metastring:'title="apps/server/src/modules/user/auth.service.ts"',children:"// ...\r\nimport { LoginDto, RegisterDto } from '@ying-chat/shared'\r\nimport { comparePass, generatePass } from '@/lib/utils'\r\n\r\n@Injectable()\r\nexport class AuthService {\r\n  // ...\r\n\r\n  compareCode(codeA: string, codeB: string) {\r\n    return codeA.toLowerCase() === codeB.toLowerCase()\r\n  }\r\n\r\n  async login(loginDto: LoginDto) {\r\n    const code = await this.redisClient.get(RedisKey.LoginCode + loginDto.uid)\r\n    if (!code || !this.compareCode(code, loginDto.code)) {\r\n      throw new HttpException(\r\n        { message: 'captcha error' },\r\n        HttpStatus.NOT_ACCEPTABLE\r\n      )\r\n    }\r\n    const user = await this.userRepository.findOne({\r\n      where: [\r\n        {\r\n          username: loginDto.loginName\r\n        },\r\n        {\r\n          email: loginDto.loginName\r\n        }\r\n      ]\r\n    })\r\n    if (!user) {\r\n      throw new HttpException(\r\n        { message: 'account does not exist' },\r\n        HttpStatus.NOT_ACCEPTABLE\r\n      )\r\n    }\r\n    if (!comparePass(loginDto.password, user.password)) {\r\n      throw new HttpException(\r\n        { message: 'wrong password' },\r\n        HttpStatus.NOT_ACCEPTABLE\r\n      )\r\n    }\r\n  }\r\n}\n"})}),"\n",(0,s.jsxs)(r.p,{children:["\u5728 ",(0,s.jsx)(r.code,{children:"AuthController"})," \u91cc\u52a0\u4e0a\u767b\u5f55\u63a5\u53e3\uff0c\u76f4\u63a5\u8c03\u7528 ",(0,s.jsx)(r.code,{children:"login"}),"\u3002"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",metastring:'title="apps/server/src/modules/user/auth.controller.ts"',children:"// ...\r\nimport { LoginDto, RegisterDto } from '@ying-chat/shared'\r\n\r\n@ApiTags('auth')\r\n@Controller('auth')\r\nexport class AuthController {\r\n  // ...\r\n\r\n  @ApiOperation({\r\n    summary: 'login'\r\n  })\r\n  @Post('login')\r\n  login(@Body() loginDto: LoginDto) {\r\n    return this.authService.login(loginDto)\r\n  }\r\n}\n"})}),"\n",(0,s.jsxs)(r.p,{children:["\u4f46\u662f ",(0,s.jsx)(r.code,{children:"LoginDto"})," \u8fd8\u662f\u5f97\u6253\u5305\u4e00\u4e0b\u624d\u80fd\u5f15\u7528\uff0c\u6bcf\u6b21\u6dfb\u52a0\u90fd\u8981\u6253\u5305\u592a\u9ebb\u70e6\u4e86\uff0c\u5f80",(0,s.jsx)(r.code,{children:"shared"})," \u5305\u7684",(0,s.jsx)(r.code,{children:"package.json"}),"\u52a0\u4e0a\u4e00\u4e2a dev \u547d\u4ee4\uff0c\u8fd9\u4e2a\u547d\u4ee4\u4ee5\u76d1\u542c\u5305\u5185\u6587\u4ef6\u53d8\u5316\u7684\u5f62\u5f0f\u6253\u5305\u7f16\u8bd1 ts \u6587\u4ef6\uff0c\u542f\u52a8\u8fd9\u4e2a\u547d\u4ee4\uff0c\u5c31\u4e0d\u7528\u6bcf\u6b21\u90fd\u91cd\u65b0\u6253\u5305\u4e86\u3002"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-json",metastring:'title="packages/shared/package.json"',children:'{\r\n  // ...\r\n  "scripts": {\r\n    "dev": "tsc -b -w tsconfig.json --preserveWatchOutput | tsc -b -w tsconfig.esm.json --preserveWatchOutput"\r\n    // ...\r\n  }\r\n}\n'})}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-json",metastring:'title="packages/shared/tsconfig.esm.json"',children:'{\r\n  // ...\r\n  "exclude": ["dist"]\r\n}\n'})}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-json",metastring:'title="packages/shared/tsconfig.json"',children:'{\r\n  // ...\r\n  "exclude": ["dist"]\r\n}\n'})}),"\n",(0,s.jsxs)(r.p,{children:["\u5728\u8fd9\u4e24\u4e2a ts \u914d\u7f6e\u6587\u4ef6\u52a0\u4e0a\u4e00\u4e2a ",(0,s.jsx)(r.code,{children:'"exclude": ["dist"]'})," \u5ffd\u7565\u6389 dist \u7684\u53d8\u5316\u3002"]}),"\n",(0,s.jsx)(r.h2,{id:"jwt-\u5b9e\u73b0\u9274\u6743",children:"jwt \u5b9e\u73b0\u9274\u6743"}),"\n",(0,s.jsx)(r.h3,{id:"\u767b\u5f55\u8fd4\u56de-token",children:"\u767b\u5f55\u8fd4\u56de token"}),"\n",(0,s.jsx)(r.p,{children:"\u767b\u5f55\u5b8c\u6210\u540e\uff0c\u8fd8\u9700\u8981\u8fd4\u56de\u4e00\u4e2a token \u7ed9\u524d\u7aef\u53bb\u8bf7\u6c42\u5176\u4ed6\u53d7\u4fdd\u62a4\u7684\u63a5\u53e3\uff0c\u5230\u65f6\u4e0d\u9700\u8981 token \u68c0\u9a8c\u7684\u63a5\u53e3\u5c31\u53ea\u6709\u767b\u5f55\u548c\u6ce8\u518c\u76f8\u5173\u7684\u8fd9\u51e0\u4e2a\u3002"}),"\n",(0,s.jsxs)(r.p,{children:["\u5148\u5b89\u88c5 ",(0,s.jsx)(r.code,{children:"@nestjs/jwt"})," \u8fd9\u4e2a\u4f9d\u8d56\u3002"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-shell",metastring:'title="apps/server"',children:"pnpm i @nestjs/jwt\n"})}),"\n",(0,s.jsxs)(r.p,{children:["\u5728 ",(0,s.jsx)(r.code,{children:"UserModule"})," \u91cc\u5f15\u5165 ",(0,s.jsx)(r.code,{children:"JwtModule"}),"\u3002"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",metastring:'title="apps/server/src/modules/user/user.module.ts"',children:"// ...\r\nimport { JwtModule } from '@nestjs/jwt'\r\n\r\n@Module({\r\n  imports: [TypeOrmModule.forFeature([User]), JwtModule.register({})]\r\n  // ...\r\n})\r\nexport class UserModule {}\n"})}),"\n",(0,s.jsx)(r.p,{children:"\u5728\u914d\u7f6e\u6587\u4ef6\u7684 api \u91cc\u518d\u52a0\u4e0a\u4e00\u4e2a jwt \u7684\u5bc6\u94a5\u914d\u7f6e\u3002"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-json",metastring:'title="apps/server/.env"',children:"# api\r\n// ...\r\nSERVER_JWT_SECRET=4h4gdsf2ds1f2\r\n//...\n"})}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",metastring:'title="apps/server/src/config/api.config.ts"',children:"import { registerAs } from '@nestjs/config'\r\n\r\nexport const apiConfig = registerAs('apiConfig', () => {\r\n  return {\r\n    port: process.env.SERVER_PORT || 3000,\r\n    jwtSecret: process.env.SERVER_JWT_SECRET || '' // +\r\n  }\r\n})\n"})}),"\n",(0,s.jsxs)(r.p,{children:["\u5728 ",(0,s.jsx)(r.code,{children:"AuthService"})," \u91cc\u5b8c\u5584 ",(0,s.jsx)(r.code,{children:"login"})," \u51fd\u6570\uff0c\u6821\u9a8c\u5168\u90e8\u901a\u8fc7\u540e\uff0c\u7528",(0,s.jsx)(r.code,{children:"jwtService"}),"\u7b7e\u53d1\u4e00\u4e2a token\uff0c\u7136\u540e\u5b58\u8fdb redis \u91cc\u8bbe\u7f6e 24 \u5c0f\u65f6\u540e\u8fc7\u671f\uff0c\u5220\u9664 LoginCode\uff0c\u6700\u540e\u8fd4\u56de\u7528\u6237\u4fe1\u606f\u548c token\uff0c\u7136\u540e\u518d\u6dfb\u52a0\u4e00\u4e2a ",(0,s.jsx)(r.code,{children:"verify"})," \u51fd\u6570\u53bb\u9a8c\u8bc1\u4f20\u9012\u7684 token \u662f\u5426\u6b63\u786e\uff0c\u8fd9\u4e2a\u51fd\u6570\u540e\u9762\u6dfb\u52a0\u8def\u7531\u5b88\u536b\u65f6\u518d\u4f7f\u7528\u3002"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",metastring:'title="apps/server/src/modules/user/auth.service.ts"',children:"// ...\r\nimport { JwtService } from '@nestjs/jwt'\r\nimport { ConfigType } from '@nestjs/config'\r\nimport { apiConfig } from '@/config'\r\n\r\n@Injectable()\r\nexport class AuthService {\r\n  // ...\r\n\r\n  @Inject()\r\n  private readonly jwtService: JwtService\r\n\r\n  @Inject(apiConfig.KEY)\r\n  private readonly apiConfig: ConfigType<typeof apiConfig>\r\n\r\n  // ...\r\n\r\n  async login(loginDto: LoginDto) {\r\n    // ...\r\n\r\n    const token = this.jwtService.sign(\r\n      {\r\n        id: user.id\r\n      },\r\n      {\r\n        secret: this.apiConfig.jwtSecret\r\n      }\r\n    )\r\n\r\n    await this.redisClient.set(token, user.id, {\r\n      EX: 24 * 60 * 60\r\n    })\r\n\r\n    await this.redisClient.del(RedisKey.LoginCode + loginDto.uid)\r\n\r\n    return {\r\n      user,\r\n      token\r\n    }\r\n  }\r\n\r\n  verify(token: string) {\r\n    return this.jwtService.verify(token, { secret: this.apiConfig.jwtSecret })\r\n  }\r\n}\n"})}),"\n",(0,s.jsx)(r.p,{children:"\u8c03\u8bd5\u4e00\u4e0b\u3002"}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)(r.img,{src:n(1181).A+"",width:"1290",height:"1152"})}),"\n",(0,s.jsx)(r.p,{children:"\u53ef\u4ee5\u53d1\u73b0\u6700\u540e\u8fd4\u56de\u7684\u7528\u6237\u4fe1\u606f\u91cc\u9762\u628a\u52a0\u5bc6\u540e\u7684\u5bc6\u7801\u90fd\u8fd4\u56de\u51fa\u6765\u4e86\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5148\u628a\u8fd9\u4e2a\u89e3\u51b3\u4e00\u4e0b\u3002"}),"\n",(0,s.jsx)(r.h3,{id:"\u7981\u6b62\u7528\u6237\u5b9e\u4f53\u8fd4\u56de\u5bc6\u7801",children:"\u7981\u6b62\u7528\u6237\u5b9e\u4f53\u8fd4\u56de\u5bc6\u7801"}),"\n",(0,s.jsxs)(r.p,{children:["\u4fee\u6539\u4e00\u4e0b ",(0,s.jsx)(r.code,{children:"UserEntity"}),"\uff0c\u5728\u5bc6\u7801\u4e0a\u9762\u6dfb\u52a0\u4e00\u4e2a ",(0,s.jsx)(r.code,{children:"class-transformer"})," \u7684 ",(0,s.jsx)(r.code,{children:"Exclude"})," \u88c5\u9970\u5668\uff0c\u6700\u540e\u6dfb\u52a0\u4e00\u4e2a ",(0,s.jsx)(r.code,{children:"toJSON"})," \u51fd\u6570\u5373\u53ef\u3002"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",metastring:'title="apps/server/src/modules/db/entities/user.entity.ts"',children:"// ...\r\nimport { Exclude, instanceToPlain } from 'class-transformer'\r\n\r\n@Entity({ name: 'user' })\r\nexport class UserEntity extends BaseEntity {\r\n  @Column({\r\n    length: 32,\r\n    unique: true\r\n  })\r\n  username: string\r\n\r\n  @Column({\r\n    length: 50,\r\n    unique: true\r\n  })\r\n  email: string\r\n\r\n  @Column()\r\n  @Exclude() // ++\r\n  password: string\r\n\r\n  @Column({\r\n    length: 32,\r\n    nullable: true\r\n  })\r\n  nickname: string\r\n\r\n  // ++\r\n  toJSON() {\r\n    return instanceToPlain(this)\r\n  }\r\n}\n"})}),"\n",(0,s.jsx)(r.p,{children:"\u518d\u767b\u5f55\u4e00\u4e0b\u770b\u770b\uff0c\u53d1\u73b0\u5bc6\u7801\u5df2\u7ecf\u6ca1\u4e86\u3002"}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)(r.img,{src:n(6708).A+"",width:"627",height:"431"})}),"\n",(0,s.jsx)(r.h3,{id:"\u6388\u6743\u5b88\u536b\u6dfb\u52a0",children:"\u6388\u6743\u5b88\u536b\u6dfb\u52a0"}),"\n",(0,s.jsxs)(r.p,{children:["\u5728 ",(0,s.jsx)(r.code,{children:"common"})," \u76ee\u5f55\uff0c \u65b0\u5efa ",(0,s.jsx)(r.code,{children:"decorator"})," \u6587\u4ef6\u5939\uff0c\u518d\u6dfb\u52a0\u4e00\u4e2a ",(0,s.jsx)(r.code,{children:"no-auth.decorator.ts"})," \u6587\u4ef6\uff0c\u6211\u4eec\u5728\u91cc\u9762\u6dfb\u4e00\u4e2a ",(0,s.jsx)(r.code,{children:"NotRequiredAuth"})," \u88c5\u9970\u5668\u3002"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",metastring:'title="apps/server/src/common/decorator/no-auth.decorator.ts"',children:"import { SetMetadata } from '@nestjs/common'\r\n\r\nexport const NOT_REQUIRED_AUTH = 'notRequiredAuth'\r\n\r\nexport const NotRequiredAuth = () => SetMetadata(NOT_REQUIRED_AUTH, true)\n"})}),"\n",(0,s.jsxs)(r.p,{children:["\u65b0\u5efa\u4e00\u4e2a",(0,s.jsx)(r.code,{children:"index.ts"}),"\u5bfc\u51fa\u3002"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",metastring:'title="apps\\server\\src\\common\\decorator\\index.ts"',children:"export * from './no-auth.decorator'\n"})}),"\n",(0,s.jsxs)(r.p,{children:["\u628a ",(0,s.jsx)(r.code,{children:"NotRequiredAuth"})," \u88c5\u9970\u5668\u6dfb\u52a0\u5230 ",(0,s.jsx)(r.code,{children:"AuthController"})," \u5bf9\u5e94\u7684\u51fd\u6570\u4e0a\uff0c\u8fd9\u6837\u8868\u660e\u8fd9\u4e9b\u63a5\u53e3\u90fd\u662f\u4e0d\u9700\u8981\u6388\u6743\u9a8c\u8bc1\u7684\uff0c\u7136\u540e\u5176\u4ed6\u6240\u6709\u4e0d\u52a0",(0,s.jsx)(r.code,{children:"NotRequiredAuth"})," \u7684\u90fd\u662f\u9700\u8981\u9a8c\u8bc1\u7684\u3002"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",metastring:'title="apps/server/src/modules/user/auth.controller.ts"',children:"// ...\r\nimport { NotRequiredAuth } from '@/common/decorator'\r\n\r\n// ...\r\nexport class AuthController {\r\n  // ...\r\n  @NotRequiredAuth()\r\n  register() {}\r\n\r\n  // ...\r\n  @NotRequiredAuth()\r\n  sendCode() {}\r\n\r\n  // ...\r\n  @NotRequiredAuth()\r\n  async getCaptcha() {}\r\n\r\n  // ...\r\n  @NotRequiredAuth()\r\n  login() {}\r\n}\n"})}),"\n",(0,s.jsxs)(r.p,{children:["\u5728 ",(0,s.jsx)(r.code,{children:"common"})," \u76ee\u5f55\uff0c \u65b0\u5efa ",(0,s.jsx)(r.code,{children:"guard"})," \u6587\u4ef6\u5939\uff0c\u518d\u6dfb\u52a0\u4e00\u4e2a ",(0,s.jsx)(r.code,{children:"auth.guard.ts"})," \u6587\u4ef6\uff0c\u6211\u4eec\u5728\u91cc\u9762\u5b9e\u73b0\u4e00\u4e2a ",(0,s.jsx)(r.code,{children:"AuthGuard"})," \u5b88\u536b\u6765\u5bf9\u7528\u6237\u7684 token \u8fdb\u884c\u6821\u9a8c\u3002"]}),"\n",(0,s.jsxs)(r.p,{children:["\u4e3b\u8981\u903b\u8f91\u4e3a\uff0c\u5982\u679c\u88ab",(0,s.jsx)(r.code,{children:"NotRequiredAuth"}),"\u6807\u8bb0\u8fc7\uff0c\u8bf4\u660e\u63a5\u53e3\u4e0d\u9700\u8981\u68c0\u9a8c\uff0c\u76f4\u63a5\u653e\u884c\uff0c\u5982\u679c\u6ca1\u6709\uff0c\u5219\u4ece redis \u770b\u770b\u7528\u6237\u7684 token \u662f\u5426\u6b63\u786e\u3002"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",metastring:'title="apps/server/src/common/guard/auth.guard.ts"',children:"import {\r\n  CanActivate,\r\n  ExecutionContext,\r\n  HttpException,\r\n  HttpStatus,\r\n  Inject,\r\n  Injectable\r\n} from '@nestjs/common'\r\nimport { Reflector } from '@nestjs/core'\r\nimport { Request } from 'express'\r\nimport { RedisClientType } from 'redis'\r\nimport { AuthService } from '@/modules/user/auth.service'\r\nimport { NOT_REQUIRED_AUTH } from '@/common/decorator'\r\nimport { RedisToken } from '@/modules/redis/constant'\r\n\r\ndeclare module 'express' {\r\n  interface Request {\r\n    userId: number\r\n  }\r\n}\r\n\r\n@Injectable()\r\nexport class AuthGuard implements CanActivate {\r\n  constructor(\r\n    private readonly reflector: Reflector,\r\n    private readonly authService: AuthService,\r\n    @Inject(RedisToken)\r\n    private readonly redisClient: RedisClientType\r\n  ) {}\r\n\r\n  async canActivate(context: ExecutionContext): Promise<boolean> {\r\n    const handler = context.getHandler()\r\n    const classContext = context.getClass()\r\n    const isNotRequiredAuth = this.reflector.getAllAndOverride<boolean>(\r\n      NOT_REQUIRED_AUTH,\r\n      [handler, classContext]\r\n    )\r\n\r\n    if (isNotRequiredAuth) {\r\n      return true\r\n    }\r\n\r\n    const request = context.switchToHttp().getRequest<Request>()\r\n\r\n    try {\r\n      const token = request.headers['authorization'].split('Bearer ')[1]\r\n\r\n      const verifyData = this.authService.verify(token)\r\n      const id = Number(await this.redisClient.get(token))\r\n\r\n      if (id === verifyData.id) {\r\n        request.userId = id\r\n        return true\r\n      }\r\n\r\n      throw new HttpException('unauthorized', HttpStatus.UNAUTHORIZED)\r\n    } catch (error) {\r\n      throw new HttpException('unauthorized', HttpStatus.UNAUTHORIZED)\r\n    }\r\n  }\r\n}\n"})}),"\n",(0,s.jsxs)(r.p,{children:["\u65b0\u5efa\u4e00\u4e2a ",(0,s.jsx)(r.code,{children:"index.ts"})," \u5bfc\u51fa\u3002"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",metastring:'title="apps/server/src/common/guard/index.ts"',children:"export * from './auth.guard'\n"})}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",metastring:'title="apps/server/src/app.module.ts"',children:"// ...\r\nimport { APP_GUARD } from '@nestjs/core'\r\nimport { AuthGuard } from '@/common/guard'\r\n\r\n@Module({\r\n  // ...\r\n  providers: [\r\n    {\r\n      provide: APP_GUARD,\r\n      useClass: AuthGuard\r\n    }\r\n  ]\r\n})\r\nexport class AppModule {}\n"})}),"\n",(0,s.jsxs)(r.p,{children:["\u6b64\u65f6\u4fdd\u5b58\u4f1a\u62a5\u9519\uff0c\u56e0\u4e3a",(0,s.jsx)(r.code,{children:"AuthGuard"}),"\u4f7f\u7528\u5230\u4e86",(0,s.jsx)(r.code,{children:"UserModule"}),"\u91cc\u7684",(0,s.jsx)(r.code,{children:"AuthService"}),"\uff0c\u6240\u4ee5\u8fd8\u8981\u628a",(0,s.jsx)(r.code,{children:"AuthService"}),"\u5bfc\u51fa\u4e00\u4e0b\u3002"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",metastring:'title="apps/server/src/modules/user/user.module.ts"',children:"// ...\r\n\r\n@Module({\r\n  // ...\r\n  exports: [AuthService]\r\n})\r\nexport class UserModule {}\n"})}),"\n",(0,s.jsx)(r.h2,{id:"\u7528\u6237\u4fe1\u606f\u63a5\u53e3",children:"\u7528\u6237\u4fe1\u606f\u63a5\u53e3"}),"\n",(0,s.jsx)(r.p,{children:"\u63a5\u4e0b\u6765\u6dfb\u52a0\u4e00\u4e0b\u67e5\u770b\u7528\u6237\u4fe1\u606f\u7684\u63a5\u53e3\u53bb\u8c03\u8bd5\u4e00\u4e0b\u6388\u6743\u68c0\u9a8c\u662f\u5426\u751f\u6548\u3002"}),"\n",(0,s.jsxs)(r.p,{children:["\u6dfb\u52a0\u4e00\u4e2a",(0,s.jsx)(r.code,{children:"user.service.ts"}),"\uff0c\u5b9e\u73b0",(0,s.jsx)(r.code,{children:"getUserInfo"}),"\u51fd\u6570\u83b7\u53d6\u7528\u6237\u4fe1\u606f\u3002"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",metastring:'title="apps/server/src/modules/user/user.service.ts"',children:"import { HttpException, HttpStatus, Injectable } from '@nestjs/common'\r\nimport { InjectRepository } from '@nestjs/typeorm'\r\nimport { Repository } from 'typeorm'\r\nimport { UserEntity } from '@/modules/db/entities'\r\n\r\n@Injectable()\r\nexport class UserService {\r\n  @InjectRepository(UserEntity)\r\n  private readonly userRepository: Repository<UserEntity>\r\n\r\n  async getUserInfo(userId: number) {\r\n    const user = await this.userRepository.findOne({\r\n      where: { id: userId }\r\n    })\r\n\r\n    if (!user) {\r\n      throw new HttpException('user is not exists', HttpStatus.NOT_FOUND)\r\n    }\r\n\r\n    return user\r\n  }\r\n}\n"})}),"\n",(0,s.jsxs)(r.p,{children:["\u6dfb\u52a0\u4e00\u4e2a ",(0,s.jsx)(r.code,{children:"user.controller.ts"}),"\u3002"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",metastring:'title="apps/server/src/modules/user/user.controller.ts"',children:"import { Controller, Get, Param } from '@nestjs/common'\r\nimport { ApiOperation, ApiTags } from '@nestjs/swagger'\r\nimport { UserService } from './user.service'\r\n\r\n@ApiTags('user')\r\n@Controller('user')\r\nexport class UserController {\r\n  constructor(private readonly userService: UserService) {}\r\n\r\n  @ApiOperation({\r\n    summary: 'getUserInfo'\r\n  })\r\n  @Get(':id')\r\n  getUserInfo(@Param('id') id: number) {\r\n    return this.userService.getUserInfo(id)\r\n  }\r\n}\n"})}),"\n",(0,s.jsxs)(r.p,{children:["\u5728 ",(0,s.jsx)(r.code,{children:"UserModule"})," \u91cc\u6dfb\u52a0 ",(0,s.jsx)(r.code,{children:"UserController"})," \u548c ",(0,s.jsx)(r.code,{children:"UserService"}),"\u3002"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",metastring:'title="apps/server/src/modules/user/user.module.ts"',children:"// ...\r\nimport { UserController } from './user.controller'\r\nimport { UserService } from './user.service'\r\n\r\n@Module({\r\n  // ...\r\n  controllers: [AuthController, UserController],\r\n  providers: [AuthService, UserService]\r\n})\r\nexport class UserModule {}\n"})}),"\n",(0,s.jsx)(r.p,{children:"\u8c03\u8bd5\u4e00\u4e0b\u3002"}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)(r.img,{src:n(4087).A+"",width:"1290",height:"1152"})}),"\n",(0,s.jsxs)(r.p,{children:["\u8c03\u8bd5\u5b8c\u540e\u628a",(0,s.jsx)(r.code,{children:"getUserInfo"}),"\u6539\u6210\u76f4\u63a5\u8bfb\u53d6\u7528\u6237\u5728\u7ecf\u8fc7\u8def\u7531\u5b88\u536b\u65f6\u6dfb\u52a0\u7684 userId\uff0c\u4e0d\u8981\u8ba9\u5176\u6839\u636e id \u76f4\u63a5\u83b7\u53d6\u7528\u6237\u4fe1\u606f\u3002"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",metastring:'title="apps/server/src/modules/user/user.controller.ts"',children:"import { Controller, Get, Req, Param } from '@nestjs/common'\r\nimport { ApiOperation, ApiTags } from '@nestjs/swagger'\r\nimport { Request } from 'express'\r\nimport { UserService } from './user.service'\r\n\r\n@ApiTags('user')\r\n@Controller('user')\r\nexport class UserController {\r\n  constructor(private readonly userService: UserService) {}\r\n\r\n  @ApiOperation({\r\n    summary: 'getUserInfo'\r\n  })\r\n  @Get()\r\n  getUserInfo(@Req() request: Request) {\r\n    return this.userService.getUserInfo(request.userId)\r\n  }\r\n}\n"})}),"\n",(0,s.jsx)(r.h2,{id:"\u9000\u51fa\u767b\u5f55\u63a5\u53e3",children:"\u9000\u51fa\u767b\u5f55\u63a5\u53e3"}),"\n",(0,s.jsx)(r.p,{children:"\u5728\u7ed3\u675f\u4e4b\u524d\u518d\u987a\u4fbf\u6dfb\u52a0\u4e00\u4e2a\u9000\u51fa\u767b\u5f55\u63a5\u53e3\u3002"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",metastring:'title="apps/server/src/modules/user/auth.service.ts"',children:"// ...\r\n\r\n@Injectable()\r\nexport class AuthService {\r\n  // ...\r\n\r\n  async logout(token: string) {\r\n    await this.redisClient.del(token)\r\n  }\r\n}\n"})}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",metastring:'title="apps/server/src/modules/user/auth.controller.ts"',children:"import {\r\n  // ...\r\n  Headers\r\n} from '@nestjs/common'\r\n\r\n@ApiTags('auth')\r\n@Controller('auth')\r\nexport class AuthController {\r\n  // ...\r\n\r\n  @ApiOperation({\r\n    summary: 'logout'\r\n  })\r\n  @Get('logout')\r\n  logout(@Headers('authorization') authorization: string) {\r\n    return this.authService.logout(authorization.split('Bearer ')[1])\r\n  }\r\n}\n"})}),"\n",(0,s.jsx)(r.p,{children:"\u90a3\u4e48\u672c\u8282\u5230\u6b64\u7ed3\u675f\u3002"})]})}function p(e={}){const{wrapper:r}={...(0,t.R)(),...e.components};return r?(0,s.jsx)(r,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8917:(e,r,n)=>{n.d(r,{A:()=>s});const s=n.p+"assets/images/01-0e517a9f907e0dc3c57956b40362c8a4.png"},1181:(e,r,n)=>{n.d(r,{A:()=>s});const s=n.p+"assets/images/02-f7c76a82b168cecc806a8c06b9b267d5.gif"},6708:(e,r,n)=>{n.d(r,{A:()=>s});const s=n.p+"assets/images/03-b29d30af5817b6bc7f2b6e39e786b748.png"},4087:(e,r,n)=>{n.d(r,{A:()=>s});const s=n.p+"assets/images/04-99f975c25e9f72a3f225a1a46a1204b9.gif"},9128:(e,r,n)=>{n.d(r,{R:()=>o,x:()=>c});var s=n(9474);const t={},i=s.createContext(t);function o(e){const r=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function c(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),s.createElement(i.Provider,{value:r},e.children)}}}]);