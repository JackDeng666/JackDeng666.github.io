"use strict";(self.webpackChunkying_blog=self.webpackChunkying_blog||[]).push([[377],{9613:(e,n,t)=>{t.d(n,{Zo:()=>m,kt:()=>f});var r=t(9496);function i(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function a(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function s(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?a(Object(t),!0).forEach((function(n){i(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,r,i=function(e,n){if(null==e)return{};var t,r,i={},a=Object.keys(e);for(r=0;r<a.length;r++)t=a[r],n.indexOf(t)>=0||(i[t]=e[t]);return i}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)t=a[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var o=r.createContext({}),p=function(e){var n=r.useContext(o),t=n;return e&&(t="function"==typeof e?e(n):s(s({},n),e)),t},m=function(e){var n=p(e.components);return r.createElement(o.Provider,{value:n},e.children)},c="mdxType",u={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},d=r.forwardRef((function(e,n){var t=e.components,i=e.mdxType,a=e.originalType,o=e.parentName,m=l(e,["components","mdxType","originalType","parentName"]),c=p(t),d=i,f=c["".concat(o,".").concat(d)]||c[d]||u[d]||a;return t?r.createElement(f,s(s({ref:n},m),{},{components:t})):r.createElement(f,s({ref:n},m))}));function f(e,n){var t=arguments,i=n&&n.mdxType;if("string"==typeof e||i){var a=t.length,s=new Array(a);s[0]=d;var l={};for(var o in n)hasOwnProperty.call(n,o)&&(l[o]=n[o]);l.originalType=e,l[c]="string"==typeof e?e:i,s[1]=l;for(var p=2;p<a;p++)s[p]=t[p];return r.createElement.apply(null,s)}return r.createElement.apply(null,t)}d.displayName="MDXCreateElement"},9954:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>s,default:()=>u,frontMatter:()=>a,metadata:()=>l,toc:()=>p});var r=t(8957),i=(t(9496),t(9613));const a={id:"user-avatar-and-integrated-minio",sidebar_label:"\u7528\u6237\u5934\u50cf\u548c\u96c6\u6210MinIO",title:"\u7528\u6237\u5934\u50cf\u548c\u96c6\u6210MinIO"},s=void 0,l={unversionedId:"ying-chat/user-avatar-and-integrated-minio",id:"ying-chat/user-avatar-and-integrated-minio",title:"\u7528\u6237\u5934\u50cf\u548c\u96c6\u6210MinIO",description:"\u672c\u8282\u6765\u5b9e\u73b0\u7528\u6237\u5934\u50cf\u7684\u529f\u80fd\uff0c\u672c\u5e94\u7528\u5c06\u4f7f\u7528 MinIO \u6765\u5b9e\u73b0\u5e94\u7528\u4ea7\u751f\u7684\u6240\u6709\u9759\u6001\u8d44\u6e90\u7684\u5b58\u50a8\uff0c\u5982\u7528\u6237\u5934\u50cf\u3001\u6d88\u606f\u56fe\u7247\u3001\u89c6\u9891\u7b49\u3002",source:"@site/docs/ying-chat/13-integrated-minio-and-user-avatar.md",sourceDirName:"ying-chat",slug:"/ying-chat/user-avatar-and-integrated-minio",permalink:"/docs/ying-chat/user-avatar-and-integrated-minio",draft:!1,tags:[],version:"current",sidebarPosition:13,frontMatter:{id:"user-avatar-and-integrated-minio",sidebar_label:"\u7528\u6237\u5934\u50cf\u548c\u96c6\u6210MinIO",title:"\u7528\u6237\u5934\u50cf\u548c\u96c6\u6210MinIO"},sidebar:"yingChat",previous:{title:"\u4fee\u6539\u7528\u6237\u4fe1\u606f\u529f\u80fd\u6dfb\u52a0",permalink:"/docs/ying-chat/update-userinfo"},next:{title:"\u7fa4\u7ec4\u76f8\u5173api\u5b9e\u73b0",permalink:"/docs/ying-chat/group-api"}},o={},p=[{value:"\u542f\u52a8 MinIO \u5bb9\u5668",id:"\u542f\u52a8-minio-\u5bb9\u5668",level:2},{value:"\u96c6\u6210 MinIO",id:"\u96c6\u6210-minio",level:2},{value:"MinIO \u914d\u7f6e\u521d\u59cb\u5316",id:"minio-\u914d\u7f6e\u521d\u59cb\u5316",level:3},{value:"shared \u5305\u914d\u7f6e",id:"shared-\u5305\u914d\u7f6e",level:3},{value:"\u5b9e\u73b0\u4e0a\u4f20\u6587\u4ef6\u6a21\u5757",id:"\u5b9e\u73b0\u4e0a\u4f20\u6587\u4ef6\u6a21\u5757",level:3},{value:"\u7528\u6237\u4e0a\u4f20\u5934\u50cf\u63a5\u53e3",id:"\u7528\u6237\u4e0a\u4f20\u5934\u50cf\u63a5\u53e3",level:2},{value:"\u52a0\u8f7d\u6587\u4ef6\u65f6\u66f4\u65b0\u6709\u6548\u6587\u4ef6\u5730\u5740",id:"\u52a0\u8f7d\u6587\u4ef6\u65f6\u66f4\u65b0\u6709\u6548\u6587\u4ef6\u5730\u5740",level:2},{value:"\u524d\u7aef\u5bf9\u63a5\u4e0a\u4f20\u7528\u6237\u5934\u50cf",id:"\u524d\u7aef\u5bf9\u63a5\u4e0a\u4f20\u7528\u6237\u5934\u50cf",level:2},{value:"\u56fe\u7247\u4e0a\u4f20\u7ec4\u4ef6\u5c01\u88c5",id:"\u56fe\u7247\u4e0a\u4f20\u7ec4\u4ef6\u5c01\u88c5",level:3},{value:"\u5bf9\u63a5\u4e0a\u4f20\u7528\u6237\u5934\u50cf",id:"\u5bf9\u63a5\u4e0a\u4f20\u7528\u6237\u5934\u50cf",level:3}],m={toc:p},c="wrapper";function u(e){let{components:n,...a}=e;return(0,i.kt)(c,(0,r.Z)({},m,a,{components:n,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"\u672c\u8282\u6765\u5b9e\u73b0\u7528\u6237\u5934\u50cf\u7684\u529f\u80fd\uff0c\u672c\u5e94\u7528\u5c06\u4f7f\u7528 MinIO \u6765\u5b9e\u73b0\u5e94\u7528\u4ea7\u751f\u7684\u6240\u6709\u9759\u6001\u8d44\u6e90\u7684\u5b58\u50a8\uff0c\u5982\u7528\u6237\u5934\u50cf\u3001\u6d88\u606f\u56fe\u7247\u3001\u89c6\u9891\u7b49\u3002"),(0,i.kt)("p",null,"\u9996\u5148\u5148\u8ba9\u6211\u4ecb\u7ecd\u4e00\u4e0b MinIO \uff1a\u5b83\u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u5bf9\u8c61\u5b58\u50a8\u670d\u52a1\u5668\uff0c\u5b83\u53ef\u4ee5\u5e2e\u52a9\u4f60\u6784\u5efa\u81ea\u5df1\u7684\u79c1\u6709\u4e91\u5b58\u50a8\u89e3\u51b3\u65b9\u6848\u3002\u5b83\u7684\u8bbe\u8ba1\u76ee\u6807\u662f\u517c\u5bb9 Amazon S3\uff08Simple Storage Service\uff09\uff0c\u8fd9\u610f\u5473\u7740\u4f60\u53ef\u4ee5\u4f7f\u7528\u4e0e S3 \u76f8\u540c\u7684 API \u6765\u7ba1\u7406\u548c\u8bbf\u95ee\u5b58\u50a8\u5728 MinIO \u4e2d\u7684\u5bf9\u8c61\u3002\n\u5b83\u7684\u4e3b\u8981\u7528\u9014\u662f\u4f5c\u4e3a\u5bf9\u8c61\u5b58\u50a8\u89e3\u51b3\u65b9\u6848\uff0c\u7528\u4e8e\u5b58\u50a8\u548c\u7ba1\u7406\u5927\u91cf\u7684\u975e\u7ed3\u6784\u5316\u6570\u636e\uff0c\u5982\u56fe\u7247\u3001\u89c6\u9891\u3001\u65e5\u5fd7\u3001\u5907\u4efd\u6587\u4ef6\u7b49\u3002"),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://min.io/docs/minio/container/index.html"},"minio \u542f\u52a8\u6587\u6863")),(0,i.kt)("h2",{id:"\u542f\u52a8-minio-\u5bb9\u5668"},"\u542f\u52a8 MinIO \u5bb9\u5668"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'docker run --name minio-test -d \\\n  -p 9000:9000 \\\n  -p 9090:9090 \\\n  -v D:/DockerData/ContainerBackup/minio-data:/data \\\n  -e MINIO_ROOT_USER=ying \\\n  -e MINIO_ROOT_PASSWORD=ying123456 \\\n  minio/minio server /data --console-address ":9090"\n')),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"/data")," \u662f MinIO \u5bb9\u5668\u5185\u7684\u6570\u636e\u5b58\u50a8\u4f4d\u7f6e"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"--console-address")," \u662f MinIO \u7684\u540e\u53f0\u7ba1\u7406\u5730\u5740\u7aef\u53e3"),(0,i.kt)("p",null,"\u5982\u679c\u662f\u5728 windows \u4e0b\u4f7f\u7528 GitBash \u8dd1\u547d\u4ee4\uff0c\u628a ",(0,i.kt)("inlineCode",{parentName:"p"},"/data")," \u6539\u4e3a ",(0,i.kt)("inlineCode",{parentName:"p"},"./data")," \uff0c\u5426\u5219\u4f1a\u65e0\u6cd5\u6b63\u786e\u4f7f\u7528\u8def\u5f84\u3002"),(0,i.kt)("p",null,"\u5982\u679c\u662f\u5728 windows \u4e0b\u4f7f\u7528 cmd \u8dd1\u547d\u4ee4\uff0c\u628a ",(0,i.kt)("inlineCode",{parentName:"p"},"\\")," \u6362\u884c\u7b26\u6539\u4e3a ",(0,i.kt)("inlineCode",{parentName:"p"},"^")," \u5373\u53ef\u3002"),(0,i.kt)("p",null,"\u542f\u52a8\u5b8c\u6210\u540e\u5373\u53ef\u6253\u5f00 MinIO \u7684\u540e\u53f0\u7ba1\u7406\u7cfb\u7edf"),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"http://localhost:9090"},"http://localhost:9090")),(0,i.kt)("p",null,"\u7136\u540e\u5728\u91cc\u9762\u6dfb\u52a0\u4e00\u4e2a ",(0,i.kt)("inlineCode",{parentName:"p"},"Access Key"),"\uff0c\u540e\u9762\u670d\u52a1\u7aef\u8981\u7528\u8fd9\u4e2a",(0,i.kt)("inlineCode",{parentName:"p"},"Access Key"),"\u8fde\u63a5 MinIO\u3002"),(0,i.kt)("h2",{id:"\u96c6\u6210-minio"},"\u96c6\u6210 MinIO"),(0,i.kt)("h3",{id:"minio-\u914d\u7f6e\u521d\u59cb\u5316"},"MinIO \u914d\u7f6e\u521d\u59cb\u5316"),(0,i.kt)("p",null,"\u5728\u670d\u52a1\u7aef\u4e0b\u6765\u4f9d\u8d56\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell",metastring:'title="apps/server"',title:'"apps/server"'},"pnpm i minio\n")),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://min.io/docs/minio/linux/developers/javascript/API.html"},"minio \u7684 js \u5e93\u6587\u6863")),(0,i.kt)("p",null,"\u6dfb\u52a0\u65b0\u7684\u914d\u7f6e"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json",metastring:'title="apps/server/.env"',title:'"apps/server/.env"'},"# minio\nMINIO_HOST=localhost\nMINIO_PORT=9000\nMINIO_ACCESS_KEY=Jd86dW5F1aXvfcQroe5e\nMINIO_SECRET_KEY=RlQqCWexfztJAQ8A17VS3bdZAj22WhFrWvJBbBQ6\n")),(0,i.kt)("p",null,"\u65b0\u5efa ",(0,i.kt)("inlineCode",{parentName:"p"},"minio.config.ts")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="apps/server/src/config/minio.config.ts"',title:'"apps/server/src/config/minio.config.ts"'},"import { registerAs } from '@nestjs/config'\n\nexport const minioConfig = registerAs('minioConfig', () => {\n  if (!process.env.MINIO_HOST) {\n    throw new Error('MINIO_HOST is not exist')\n  }\n  if (!process.env.MINIO_PORT) {\n    throw new Error('MINIO_PORT is not exist')\n  }\n  if (!process.env.MINIO_ACCESS_KEY) {\n    throw new Error('MINIO_ACCESS_KEY is not exist')\n  }\n  if (!process.env.MINIO_SECRET_KEY) {\n    throw new Error('MINIO_SECRET_KEY is not exist')\n  }\n  return {\n    host: process.env.MINIO_HOST,\n    port: +process.env.MINIO_PORT,\n    accessKey: process.env.MINIO_ACCESS_KEY,\n    secretKey: process.env.MINIO_SECRET_KEY\n  }\n})\n")),(0,i.kt)("p",null,"\u522b\u5fd8\u4e86\u5bfc\u51fa"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="apps/server/src/config/index.ts"',title:'"apps/server/src/config/index.ts"'},"// ...\nexport * from './minio.config'\n")),(0,i.kt)("p",null,"\u8bb0\u5f97\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"AppModule"),"\u91cc\u52a0\u8f7d\u4e00\u4e0b",(0,i.kt)("inlineCode",{parentName:"p"},"minioConfig"),"\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="apps/server/src/app.module.ts"',title:'"apps/server/src/app.module.ts"'},"import {\n  //...\n  minioConfig\n} from '@/config'\n\n@Module({\n  imports: [\n    ConfigModule.forRoot({\n      isGlobal: true,\n      load: [\n        // ...\n        minioConfig\n      ]\n    })\n    // ...\n  ]\n  // ...\n})\nexport class AppModule {}\n")),(0,i.kt)("h3",{id:"shared-\u5305\u914d\u7f6e"},"shared \u5305\u914d\u7f6e"),(0,i.kt)("p",null,"\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"shared"),"\u5305\u65b0\u5efa\u4e00\u4e2a",(0,i.kt)("inlineCode",{parentName:"p"},"enum"),"\u6587\u4ef6\u5939\uff0c\u6dfb\u52a0\u4e00\u4e2a",(0,i.kt)("inlineCode",{parentName:"p"},"file.enum.ts"),"\u6587\u4ef6\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="packages/shared/src/enum/file.enum.ts"',title:'"packages/shared/src/enum/file.enum.ts"'},"export enum FileType {\n  Avatar,\n  Cover,\n  Image,\n  Video\n}\n")),(0,i.kt)("p",null,"\u65b0\u5efa\u4e00\u4e2a",(0,i.kt)("inlineCode",{parentName:"p"},"index.ts"),"\u5bfc\u51fa\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="packages/shared/src/enum/index.ts"',title:'"packages/shared/src/enum/index.ts"'},"export * from './file.enum'\n")),(0,i.kt)("p",null,"\u5bfc\u51fa\u6574\u4e2a",(0,i.kt)("inlineCode",{parentName:"p"},"enum"),"\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="packages/shared/src/index.ts"',title:'"packages/shared/src/index.ts"'},"// ...\nexport * from './enum'\n")),(0,i.kt)("p",null,"\u65b0\u5efa\u4e00\u4e2a",(0,i.kt)("inlineCode",{parentName:"p"},"file.vo.ts"),"\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="packages/shared/src/vo/file.vo.ts"',title:'"packages/shared/src/vo/file.vo.ts"'},"import { FileType } from '../enum'\n\nexport type FileVo = {\n  id: number\n  name: string\n  type: FileType\n  url: string\n}\n")),(0,i.kt)("p",null,"\u5bfc\u51fa\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="packages/shared/src/vo/index.ts"',title:'"packages/shared/src/vo/index.ts"'},"// ...\nexport * from './file.vo'\n")),(0,i.kt)("h3",{id:"\u5b9e\u73b0\u4e0a\u4f20\u6587\u4ef6\u6a21\u5757"},"\u5b9e\u73b0\u4e0a\u4f20\u6587\u4ef6\u6a21\u5757"),(0,i.kt)("p",null,"\u6dfb\u52a0\u4e00\u4e2a",(0,i.kt)("inlineCode",{parentName:"p"},"FileEntity"),"\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="apps/server/src/modules/db/entities/file.entity.ts"',title:'"apps/server/src/modules/db/entities/file.entity.ts"'},"import { Column, Entity, JoinColumn, ManyToOne } from 'typeorm'\nimport { FileType } from '@ying-chat/shared'\nimport { BaseEntity, UserEntity } from '.'\n\n@Entity({ name: 'file' })\nexport class FileEntity extends BaseEntity {\n  @Column({\n    length: 50,\n    unique: true\n  })\n  path: string\n\n  @Column({\n    type: 'enum',\n    enum: FileType\n  })\n  type: FileType\n\n  @Column({\n    length: 2083\n  })\n  url: string\n\n  @Column()\n  createById: number\n\n  @ManyToOne(() => UserEntity)\n  @JoinColumn()\n  createBy: UserEntity\n}\n")),(0,i.kt)("p",null,"\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"index.ts"),"\u5bfc\u51fa\u4e00\u4e0b\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="apps/server/src/modules/db/entities/index.ts"',title:'"apps/server/src/modules/db/entities/index.ts"'},"// ...\nexport * from './file.entity'\n")),(0,i.kt)("p",null,"\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"modules"),"\u4e0b\u65b0\u5efa ",(0,i.kt)("inlineCode",{parentName:"p"},"file")," \u6587\u4ef6\u5939\uff0c\u7136\u540e\u6dfb\u52a0\u4e00\u4e2a ",(0,i.kt)("inlineCode",{parentName:"p"},"constant.ts"),"\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="apps/server/src/modules/file/constant.ts"',title:'"apps/server/src/modules/file/constant.ts"'},"export const MINIO_TOKEN = 'MINIO_CLIENT'\n\nexport const BUCKET_NAME = 'ying-chat'\n\nexport const EXPIR_SECONDS = 24 * 60 * 60\n")),(0,i.kt)("p",null,"\u6dfb\u52a0\u4e00\u4e2a",(0,i.kt)("inlineCode",{parentName:"p"},"file.service.ts"),"\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="apps/server/src/modules/file/file.service.ts"',title:'"apps/server/src/modules/file/file.service.ts"'},"import { Inject, Injectable } from '@nestjs/common'\nimport { InjectRepository } from '@nestjs/typeorm'\nimport { Repository } from 'typeorm'\nimport { Client, ItemBucketMetadata } from 'minio'\nimport { nanoid } from 'nanoid'\nimport { FileType } from '@ying-chat/shared'\nimport { FileEntity } from '@/modules/db/entities'\nimport { BUCKET_NAME, EXPIR_SECONDS, MINIO_TOKEN } from './constant'\n\ntype UploadFileOptions = {\n  file: Express.Multer.File\n  fileType: FileType\n  userId: number\n  meteData?: ItemBucketMetadata\n}\n\n@Injectable()\nexport class FileService {\n  @Inject(MINIO_TOKEN)\n  private readonly minioClient: Client\n\n  @InjectRepository(FileEntity)\n  private readonly minioFileRepository: Repository<FileEntity>\n\n  async uploadFile({ file, fileType, userId, meteData }: UploadFileOptions) {\n    const fileName = nanoid()\n    const objectName = `${fileType}/${fileName}`\n\n    await this.minioClient.putObject(BUCKET_NAME, objectName, file.buffer, {\n      'Content-Type': file.mimetype,\n      userId,\n      ...meteData\n    })\n    const url = await this.getPresignedUrl(objectName)\n\n    const minioFile = this.minioFileRepository.create({\n      type: fileType,\n      path: objectName,\n      url,\n      createById: userId\n    })\n    await this.minioFileRepository.save(minioFile)\n\n    return minioFile\n  }\n\n  getPresignedUrl(objectName: string) {\n    return this.minioClient.presignedUrl(\n      'get',\n      BUCKET_NAME,\n      objectName,\n      EXPIR_SECONDS\n    )\n  }\n}\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell",metastring:'title="apps/server"',title:'"apps/server"'},"pnpm i -D @types/multer\n")),(0,i.kt)("p",null,"\u5b89\u88c5\u4e00\u4e0b\u8fd9\u4e2a\u5e93\uff0c\u8fd9\u6837\u5c31\u80fd\u4f7f\u7528",(0,i.kt)("inlineCode",{parentName:"p"},"Express.Multer.File"),"\u8fd9\u4e2a\u7c7b\u578b\u3002"),(0,i.kt)("p",null,"\u6dfb\u52a0\u4e00\u4e2a",(0,i.kt)("inlineCode",{parentName:"p"},"FileModule"),"\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="apps/server/src/modules/file/file.module.ts"',title:'"apps/server/src/modules/file/file.module.ts"'},"import { Global, Module } from '@nestjs/common'\nimport { TypeOrmModule } from '@nestjs/typeorm'\nimport { Client } from 'minio'\nimport { ConfigType } from '@nestjs/config'\nimport { minioConfig } from '@/config'\nimport { FileEntity } from '@/modules/db/entities'\nimport { FileService } from './file.service'\nimport { BUCKET_NAME, MINIO_TOKEN } from './constant'\n\n@Global()\n@Module({\n  imports: [TypeOrmModule.forFeature([FileEntity])],\n  providers: [\n    {\n      provide: MINIO_TOKEN,\n      async useFactory(minioConf: ConfigType<typeof minioConfig>) {\n        const minioClient = new Client({\n          endPoint: minioConf.host,\n          port: minioConf.port,\n          useSSL: false,\n          accessKey: minioConf.accessKey,\n          secretKey: minioConf.secretKey\n        })\n        const bucketExists = await minioClient.bucketExists(BUCKET_NAME)\n        if (!bucketExists) {\n          minioClient.makeBucket(BUCKET_NAME)\n        }\n        return minioClient\n      },\n      inject: [minioConfig.KEY]\n    },\n    FileService\n  ],\n  exports: [FileService]\n})\nexport class FileModule {}\n")),(0,i.kt)("p",null,"\u8bb0\u5f97\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"AppModule"),"\u91cc\u52a0\u8f7d\u4e00\u4e0b",(0,i.kt)("inlineCode",{parentName:"p"},"FileModule"),"\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="apps/server/src/app.module.ts"',title:'"apps/server/src/app.module.ts"'},"// ...\nimport { FileModule } from '@/modules/file/file.module'\n\n@Module({\n  imports: [\n    // ...\n    FileModule\n  ]\n  // ...\n})\nexport class AppModule {}\n")),(0,i.kt)("h2",{id:"\u7528\u6237\u4e0a\u4f20\u5934\u50cf\u63a5\u53e3"},"\u7528\u6237\u4e0a\u4f20\u5934\u50cf\u63a5\u53e3"),(0,i.kt)("p",null,"\u63a5\u4e0b\u6765\u5c31\u53ef\u4ee5\u5b9e\u73b0\u7528\u6237\u4e0a\u4f20\u5934\u50cf\u7684\u63a5\u53e3\u4e86\u3002"),(0,i.kt)("p",null,"\u5148\u4fee\u6539\u4e00\u4e0b",(0,i.kt)("inlineCode",{parentName:"p"},"UserEntity"),"\uff0c\u628a\u7528\u6237\u8868\u548c\u6587\u4ef6\u8868\u5173\u8054\u8d77\u6765\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="apps/server/src/modules/db/entities/user.entity.ts"',title:'"apps/server/src/modules/db/entities/user.entity.ts"'},"// ...\nimport {\n  // ...\n  JoinColumn,\n  OneToOne\n} from 'typeorm'\nimport { FileEntity } from './file.entity'\n\n@Entity({ name: 'user' })\nexport class UserEntity extends BaseEntity {\n  // ...\n\n  @Column({\n    nullable: true\n  })\n  avatarId: number\n\n  @OneToOne(() => FileEntity)\n  @JoinColumn()\n  avatar: FileEntity\n\n  // ...\n}\n")),(0,i.kt)("p",null,"\u4fee\u6539\u4e00\u4e0b",(0,i.kt)("inlineCode",{parentName:"p"},"UserService"),"\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"getUserInfo"),"\u51fd\u6570\uff0c\u518d\u6dfb\u52a0\u4e00\u4e2a",(0,i.kt)("inlineCode",{parentName:"p"},"uploadUserAvatar"),"\u51fd\u6570\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="apps/server/src/modules/user/user.service.ts"',title:'"apps/server/src/modules/user/user.service.ts"'},"// ...\nimport {\n  // ...\n  Inject\n} from '@nestjs/common'\nimport {\n  // ...\n  FileType\n} from '@ying-chat/shared'\nimport { FileService } from '@/modules/file/file.service'\n\n@Injectable()\nexport class UserService {\n  // ...\n\n  @Inject()\n  private readonly fileService: FileService\n\n  async getUserInfo(userId: number) {\n    const user = await this.userRepository.findOne({\n      where: { id: userId },\n      relations: ['avatar'] // +\n    })\n\n    // ...\n  }\n\n  // ...\n\n  async uploadUserAvatar(file: Express.Multer.File, userId: number) {\n    const minioFile = await this.fileService.uploadFile({\n      file,\n      fileType: FileType.Avatar,\n      userId\n    })\n\n    await this.userRepository.update({ id: userId }, { avatarId: minioFile.id })\n\n    return minioFile\n  }\n}\n")),(0,i.kt)("p",null,"\u6dfb\u52a0\u4e0a\u4f20\u5934\u50cf\u63a5\u53e3\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="apps/server/src/modules/user/user.controller.ts"',title:'"apps/server/src/modules/user/user.controller.ts"'},"// ...\nimport {\n  FileTypeValidator,\n  MaxFileSizeValidator,\n  ParseFilePipe,\n  UploadedFile,\n  UseInterceptors\n} from '@nestjs/common'\nimport { FileInterceptor } from '@nestjs/platform-express'\n\n@ApiTags('user')\n@Controller('user')\nexport class UserController {\n  // ...\n\n  @ApiOperation({\n    summary: 'uploadUserAvatar'\n  })\n  @Post('avatar')\n  @UseInterceptors(FileInterceptor('file'))\n  uploadUserAvatar(\n    @Req() req: Request,\n    @UploadedFile(\n      new ParseFilePipe({\n        validators: [\n          new MaxFileSizeValidator({\n            maxSize: 5 * 1024 * 1024,\n            message: 'size must less than 5MB'\n          }),\n          new FileTypeValidator({ fileType: /image\\/(png|jpeg|jpg)/ })\n        ]\n      })\n    )\n    file: Express.Multer.File\n  ) {\n    return this.userService.uploadUserAvatar(file, req.userId)\n  }\n}\n")),(0,i.kt)("h2",{id:"\u52a0\u8f7d\u6587\u4ef6\u65f6\u66f4\u65b0\u6709\u6548\u6587\u4ef6\u5730\u5740"},"\u52a0\u8f7d\u6587\u4ef6\u65f6\u66f4\u65b0\u6709\u6548\u6587\u4ef6\u5730\u5740"),(0,i.kt)("p",null,"\u6211\u4eec\u524d\u9762\u4e0a\u4f20\u6587\u4ef6\u5230 MinIO \u65f6\uff0c\u90fd\u9884\u7b7e\u4e86\u4e00\u4e2a 24 \u5c0f\u65f6\u8fc7\u671f\u7684\u6587\u4ef6\u5730\u5740\u5b58\u8fdb\u6570\u636e\u5e93\uff0c\u73b0\u5728\u8981\u4f7f\u8fd9\u4e2a\u6587\u4ef6\u5728\u52a0\u8f7d\u65f6\uff0c\u91cd\u65b0\u83b7\u53d6\u65b0\u7684\u9884\u7b7e\u5730\u5740\u3002"),(0,i.kt)("p",null,"\u6dfb\u52a0\u4e00\u4e2a",(0,i.kt)("inlineCode",{parentName:"p"},"MinioFileSubscriber"),"\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="apps/server/src/modules/file/file.subscriber.ts"',title:'"apps/server/src/modules/file/file.subscriber.ts"'},"import { Inject } from '@nestjs/common'\nimport {\n  DataSource,\n  EntitySubscriberInterface,\n  EventSubscriber,\n  Repository\n} from 'typeorm'\nimport { InjectRepository } from '@nestjs/typeorm'\nimport { Client } from 'minio'\nimport {\n  BUCKET_NAME,\n  EXPIR_SECONDS,\n  MINIO_TOKEN\n} from '@/modules/file/constant'\nimport { FileEntity } from '@/modules/db/entities'\n\n@EventSubscriber()\nexport class FileSubscriber implements EntitySubscriberInterface<FileEntity> {\n  constructor(\n    dataSource: DataSource,\n    @Inject(MINIO_TOKEN)\n    private readonly minioClient: Client,\n    @InjectRepository(FileEntity)\n    private readonly minioFileRepository: Repository<FileEntity>\n  ) {\n    dataSource.subscribers.push(this)\n  }\n\n  listenTo() {\n    return FileEntity\n  }\n\n  async afterLoad(entity: FileEntity) {\n    try {\n      if (\n        Date.now() - new Date(entity.updateAt).getTime() >\n        EXPIR_SECONDS * 1000\n      ) {\n        const newUrl = await this.minioClient.presignedUrl(\n          'get',\n          BUCKET_NAME,\n          entity.path,\n          EXPIR_SECONDS\n        )\n        entity.url = newUrl\n        this.minioFileRepository.update({ id: entity.id }, { url: newUrl })\n      }\n    } catch (error) {\n      console.error(error)\n    }\n  }\n}\n")),(0,i.kt)("p",null,"\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"FileModule"),"\u91cc\u52a0\u8f7d\u4e00\u4e0b\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="apps/server/src/modules/file/file.module.ts"',title:'"apps/server/src/modules/file/file.module.ts"'},"//...\nimport { FileSubscriber } from './file.subscriber'\n\n@Global()\n@Module({\n  // ...\n  providers: [\n    // ...\n    FileSubscriber\n  ]\n  // ...\n})\nexport class FileModule {}\n")),(0,i.kt)("h2",{id:"\u524d\u7aef\u5bf9\u63a5\u4e0a\u4f20\u7528\u6237\u5934\u50cf"},"\u524d\u7aef\u5bf9\u63a5\u4e0a\u4f20\u7528\u6237\u5934\u50cf"),(0,i.kt)("p",null,"\u5728\u7528\u6237 api \u6dfb\u52a0\u4e00\u4e2a\u4e0a\u4f20\u63a5\u53e3\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="apps/client/src/api/user.ts"',title:'"apps/client/src/api/user.ts"'},"// ...\nimport {\n  // ...\n  FileVo\n} from '@ying-chat/shared'\n\nexport function uploadUserAvatar(file: File): Promise<FileVo> {\n  const form = new FormData()\n  form.append('file', file)\n  return request.post('/user/avatar', form)\n}\n")),(0,i.kt)("h3",{id:"\u56fe\u7247\u4e0a\u4f20\u7ec4\u4ef6\u5c01\u88c5"},"\u56fe\u7247\u4e0a\u4f20\u7ec4\u4ef6\u5c01\u88c5"),(0,i.kt)("p",null,"\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"components"),"\u6dfb\u52a0\u4e00\u4e2a",(0,i.kt)("inlineCode",{parentName:"p"},"upload"),"\u6587\u4ef6\u5939\uff0c\u7136\u540e\u6dfb\u52a0\u4e00\u4e2a",(0,i.kt)("inlineCode",{parentName:"p"},"useUpload")," hook\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="apps/client/src/components/upload/use-upload.ts"',title:'"apps/client/src/components/upload/use-upload.ts"'},"import { useState } from 'react'\n\nexport enum SelectFileType {\n  Image,\n  Video\n}\n\nexport const selectFile: (type?: SelectFileType) => Promise<File> = type => {\n  return new Promise(resolve => {\n    const input = document.createElement('input')\n    input.type = 'file'\n\n    if (type === SelectFileType.Image) {\n      input.accept = 'image/png,image/jpeg,image/jpg'\n    } else if (type === SelectFileType.Video) {\n      input.accept = 'video/mp4'\n    }\n\n    input.multiple = false\n\n    input.onchange = async () => {\n      const file = input.files?.[0]\n      if (file) {\n        resolve(file)\n      }\n    }\n\n    input.click()\n  })\n}\n\ntype UseUploadOptions<T> = {\n  handleUpload: (file: File) => Promise<T>\n  onSuccess?: (res: T) => void\n}\n\nexport const useUpload = <T>({\n  handleUpload,\n  onSuccess\n}: UseUploadOptions<T>) => {\n  const [loading, setLoading] = useState(false)\n\n  const start = (type?: SelectFileType) => {\n    selectFile(type).then(async file => {\n      try {\n        setLoading(true)\n        if (handleUpload) {\n          const res = await handleUpload(file)\n          onSuccess && onSuccess(res)\n        }\n      } catch {\n      } finally {\n        setLoading(false)\n      }\n    })\n  }\n\n  return {\n    start,\n    loading\n  }\n}\n")),(0,i.kt)("p",null,"\u518d\u5199\u4e00\u4e2a",(0,i.kt)("inlineCode",{parentName:"p"},"ImageUpload"),"\u7ec4\u4ef6\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-tsx",metastring:'title="apps/client/src/components/upload/image-upload.tsx"',title:'"apps/client/src/components/upload/image-upload.tsx"'},"import { useState } from 'react'\nimport { Plus } from 'lucide-react'\nimport { CircularProgress, cn } from '@nextui-org/react'\nimport { FileVo } from '@ying-chat/shared'\nimport { SelectFileType, useUpload } from './use-upload'\n\ntype MinioUploadProps = {\n  handleUpload: (file: File) => Promise<FileVo>\n  defaultUrl?: string\n  onSuccess?: (file: FileVo) => void\n}\n\nexport const ImageUpload = ({\n  defaultUrl,\n  onSuccess,\n  handleUpload\n}: MinioUploadProps) => {\n  const [url, setUrl] = useState(defaultUrl)\n\n  const { loading, start } = useUpload({\n    handleUpload,\n    onSuccess: minioFile => {\n      setUrl(minioFile.url)\n      onSuccess && onSuccess(minioFile)\n    }\n  })\n\n  return (\n    <div\n      className=\"inline-block w-[110px] h-[110px] cursor-pointer\"\n      onClick={() => {\n        start(SelectFileType.Image)\n      }}\n    >\n      {url ? (\n        <img className=\"w-full h-full rounded-full object-cover\" src={url} />\n      ) : (\n        <div\n          className={cn(\n            'w-full h-full rounded-full border-dashed text-2xl fc border-2',\n            'bg-content2 text-foreground-500 border-foreground-500'\n          )}\n        >\n          {loading ? <CircularProgress /> : <Plus />}\n        </div>\n      )}\n    </div>\n  )\n}\n")),(0,i.kt)("p",null,"\u65b0\u5efa\u4e00\u4e2a",(0,i.kt)("inlineCode",{parentName:"p"},"index.ts"),"\u628a\u8fd9\u4e24\u4e2a\u5bfc\u51fa\u4e00\u4e0b\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="apps/client/src/components/upload/index.ts"',title:'"apps/client/src/components/upload/index.ts"'},"export * from './image-upload'\nexport * from './use-upload'\n")),(0,i.kt)("h3",{id:"\u5bf9\u63a5\u4e0a\u4f20\u7528\u6237\u5934\u50cf"},"\u5bf9\u63a5\u4e0a\u4f20\u7528\u6237\u5934\u50cf"),(0,i.kt)("p",null,"\u4fee\u6539\u4e00\u4e0b",(0,i.kt)("inlineCode",{parentName:"p"},"UserInfoModal"),"\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-tsx",metastring:'title="apps\\client\\src\\components\\modals\\user-info-modal.tsx"',title:'"apps\\client\\src\\components\\modals\\user-info-modal.tsx"'},"// ...\nimport { ImageUpload } from '@/components/upload'\nimport { setUserInfo, useAuthStore } from '@/stores'\n\n// ...\n\nexport const UserInfoModal = ({\n  open,\n  close,\n  confirmSuccess,\n  initialValues\n}: UserInfoModalProps) => {\n  //...\n\n  const userInfo = useAuthStore(state => state.userInfo)\n\n  return (\n    {/*  */}\n    <ModalBody>\n      {/*  */}\n      <div className=\"flex flex-col items-center gap-3\">\n        <p>User Avatar</p>\n        <ImageUpload\n          defaultUrl={userInfo?.avatar?.url}\n          handleUpload={file => userApi.uploadUserAvatar(file)}\n          onSuccess={res => {\n            setUserInfo({\n              ...userInfo!,\n              avatar: res\n            })\n          }}\n        />\n      </div>\n    </ModalBody>\n    {/*  */}\n  )\n}\n")),(0,i.kt)("p",null,"\u8fd9\u65f6\u5019\u4f1a\u53d1\u73b0",(0,i.kt)("inlineCode",{parentName:"p"},"userInfo"),"\u4f1a\u62a5\u7ea2\uff0c\u63d0\u793a\u7c7b\u578b\u201cUserVo\u201d\u4e0a\u4e0d\u5b58\u5728\u5c5e\u6027\u201cavatar\u201d\uff0c\u6211\u4eec\u5230",(0,i.kt)("inlineCode",{parentName:"p"},"shared"),"\u5305\u91cc\u52a0\u4e00\u4e0b\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="packages/shared/src/vo/user.vo.ts"',title:'"packages/shared/src/vo/user.vo.ts"'},"import { FileVo } from './file.vo'\n\nexport type UserVo = {\n  // ...\n  avatarId?: number\n  avatar?: FileVo\n}\n")),(0,i.kt)("p",null,"\u8fd9\u65f6\u5019\u5c31\u4e0d\u4f1a\u62a5\u9519\u4e86\u3002"),(0,i.kt)("p",null,"\u6700\u540e\u5728",(0,i.kt)("inlineCode",{parentName:"p"},"NavSidebar"),"\u4e5f\u52a0\u4e0a\u7528\u6237\u5934\u50cf\uff0c\u987a\u4fbf\u52a0\u4e0a\u6bcf\u6b21\u52a0\u8f7d\u65f6\u81ea\u52a8\u83b7\u53d6\u4e00\u4e0b\u6700\u65b0\u4fe1\u606f\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-tsx",metastring:'title="apps\\client\\src\\components\\layout\\nav-sidebar.tsx"',title:'"apps\\client\\src\\components\\layout\\nav-sidebar.tsx"'},"// ...\nimport {\n  // ...\n  useEffect\n} from 'react'\n\nexport const NavSidebar = () => {\n  // ...\n\n  useEffect(() => {\n    getUserInfo()\n  }, [])\n\n  return (\n    {/*  */}\n    <Avatar\n      className=\"cursor-pointer h-[48px] w-[48px]\"\n      src={userInfo?.avatar?.url}\n    />\n    {/*  */}\n  )\n}\n")),(0,i.kt)("p",null,"\u6d4b\u8bd5\u4e00\u4e0b\u3002"),(0,i.kt)("p",null,(0,i.kt)("img",{src:t(7162).Z,width:"1920",height:"1080"})),(0,i.kt)("p",null,"\u672c\u8282\u5230\u6b64\u7ed3\u675f\u3002"))}u.isMDXComponent=!0},7162:(e,n,t)=>{t.d(n,{Z:()=>r});const r=t.p+"assets/images/01-a33618b2d2b3a5bb19af3ab71f3db5d2.gif"}}]);