"use strict";(self.webpackChunkying_blog=self.webpackChunkying_blog||[]).push([[9625],{7390:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>p,contentTitle:()=>i,default:()=>d,frontMatter:()=>o,metadata:()=>c,toc:()=>l});var t=r(3274),s=r(9128);const o={id:"api-init",sidebar_label:"\u63a5\u53e3\u521d\u59cb\u5316",title:"\u63a5\u53e3\u521d\u59cb\u5316"},i=void 0,c={id:"ying-chat/api-init",title:"\u63a5\u53e3\u521d\u59cb\u5316",description:"\u672c\u8282\u6765\u5bf9 server \u8fdb\u884c\u4e00\u4e9b\u7edf\u4e00\u7684\u521d\u59cb\u5316\u914d\u7f6e\u3002",source:"@site/docs/ying-chat/06-api-init.md",sourceDirName:"ying-chat",slug:"/ying-chat/api-init",permalink:"/docs/ying-chat/api-init",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:6,frontMatter:{id:"api-init",sidebar_label:"\u63a5\u53e3\u521d\u59cb\u5316",title:"\u63a5\u53e3\u521d\u59cb\u5316"},sidebar:"yingChat",previous:{title:"\u524d\u7aef\u9875\u9762\u6837\u5f0f\u548c\u4e3b\u9898\u5207\u6362",permalink:"/docs/ying-chat/client-theme-style"},next:{title:"\u5b9e\u73b0\u6ce8\u518c\u63a5\u53e3",permalink:"/docs/ying-chat/register-api"}},p={},l=[{value:"\u652f\u6301 <code>@</code> \u7b26\u53f7\u4ee3\u8868 src",id:"\u652f\u6301--\u7b26\u53f7\u4ee3\u8868-src",level:2},{value:"\u6dfb\u52a0 api \u914d\u7f6e",id:"\u6dfb\u52a0-api-\u914d\u7f6e",level:2},{value:"\u7528\u6237\u6a21\u5757\u6dfb\u52a0",id:"\u7528\u6237\u6a21\u5757\u6dfb\u52a0",level:2},{value:"\u7edf\u4e00\u62e6\u622a\u5668",id:"\u7edf\u4e00\u62e6\u622a\u5668",level:2},{value:"\u7edf\u4e00\u9519\u8bef\u8fc7\u6ee4\u5668",id:"\u7edf\u4e00\u9519\u8bef\u8fc7\u6ee4\u5668",level:2}];function a(e){const n={code:"code",h2:"h2",img:"img",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(n.p,{children:["\u672c\u8282\u6765\u5bf9 ",(0,t.jsx)(n.code,{children:"server"})," \u8fdb\u884c\u4e00\u4e9b\u7edf\u4e00\u7684\u521d\u59cb\u5316\u914d\u7f6e\u3002"]}),"\n",(0,t.jsxs)(n.h2,{id:"\u652f\u6301--\u7b26\u53f7\u4ee3\u8868-src",children:["\u652f\u6301 ",(0,t.jsx)(n.code,{children:"@"})," \u7b26\u53f7\u4ee3\u8868 src"]}),"\n",(0,t.jsxs)(n.p,{children:["\u5f80 ",(0,t.jsx)(n.code,{children:"server"})," \u7684 ",(0,t.jsx)(n.code,{children:"tsconfig.json"})," \u6587\u4ef6\u6dfb\u52a0\u4ee5\u4e0b\u914d\u7f6e\u3002"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",metastring:'title="apps/server/tsconfig.json"',children:'{\r\n  "compilerOptions": {\r\n    // ...\r\n    "paths": {\r\n      "@/*": ["./src/*"]\r\n    }\r\n  }\r\n}\n'})}),"\n",(0,t.jsx)(n.h2,{id:"\u6dfb\u52a0-api-\u914d\u7f6e",children:"\u6dfb\u52a0 api \u914d\u7f6e"}),"\n",(0,t.jsx)(n.p,{children:"\u5728 sever \u76ee\u5f55\u5b89\u88c5 nestjs \u7684 config \u6a21\u5757\u3002"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",metastring:'title="apps/server"',children:"pnpm add @nestjs/config\n"})}),"\n",(0,t.jsxs)(n.p,{children:["\u7136\u540e\u6211\u4eec\u6dfb\u52a0\u4e00\u4e2a ",(0,t.jsx)(n.code,{children:".env"})," \u73af\u5883\u53d8\u91cf\u6587\u4ef6"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",metastring:'title="apps/server/.env"',children:"# api\r\nSERVER_PORT=3000\n"})}),"\n",(0,t.jsxs)(n.p,{children:["\u7136\u540e\u5728\u4ee5\u4e0b\u8def\u5f84\u6dfb\u52a0\u4e00\u4e2a ",(0,t.jsx)(n.code,{children:"api.config.ts"})," \u6587\u4ef6\u3002"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",metastring:'title="apps/server/src/config/api.config.ts"',children:"import { registerAs } from '@nestjs/config'\r\n\r\nexport const apiConfig = registerAs('apiConfig', () => {\r\n  return {\r\n    port: process.env.SERVER_PORT || 3000\r\n  }\r\n})\n"})}),"\n",(0,t.jsxs)(n.p,{children:["\u65b0\u5efa\u4e00\u4e2a ",(0,t.jsx)(n.code,{children:"index.ts"})," \u6587\u4ef6\u628a\u5b83\u5bfc\u51fa\u3002"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",metastring:'title="apps/server/src/config/index.ts"',children:"export * from './api.config'\n"})}),"\n",(0,t.jsxs)(n.p,{children:["\u7136\u540e\u5728 ",(0,t.jsx)(n.code,{children:"AppModule"})," \u91cc\u5f15\u5165 ",(0,t.jsx)(n.code,{children:"ConfigModule"}),"\u3002"]}),"\n",(0,t.jsxs)(n.p,{children:["\u539f\u6765\u521d\u59cb\u5316\u9879\u76ee\u5e26\u7684 ",(0,t.jsx)(n.code,{children:"app.controller.ts"}),"\u3001",(0,t.jsx)(n.code,{children:"app.controller.spec.ts"}),"\u3001",(0,t.jsx)(n.code,{children:"app.service.ts"})," \u8fd9\u51e0\u4e2a\u6587\u4ef6\u90fd\u53ef\u4ee5\u76f4\u63a5\u5220\u4e86\uff0c\u4e0d\u9700\u8981\u4e86\u3002"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",metastring:'title="apps/server/src/app.module.ts"',children:"import { Module } from '@nestjs/common'\r\nimport { ConfigModule } from '@nestjs/config'\r\nimport { apiConfig } from '@/config'\r\n\r\n@Module({\r\n  imports: [\r\n    ConfigModule.forRoot({\r\n      isGlobal: true,\r\n      load: [apiConfig]\r\n    })\r\n  ]\r\n})\r\nexport class AppModule {}\n"})}),"\n",(0,t.jsxs)(n.p,{children:["\u5728 ",(0,t.jsx)(n.code,{children:"bootstrap"})," \u7684\u542f\u52a8\u903b\u8f91\u91cc\u83b7\u53d6\u914d\u7f6e\u3002"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",metastring:'title="apps/server/src/main.ts"',children:"// ...\r\nimport { ConfigType } from '@nestjs/config'\r\nimport { apiConfig } from '@/config'\r\nimport { Logger } from '@nestjs/common'\r\n// ...\r\nasync function bootstrap() {\r\n  const app = await NestFactory.create(AppModule)\r\n  const apiConf = app.get<ConfigType<typeof apiConfig>>(apiConfig.KEY)\r\n  app.setGlobalPrefix('/api')\r\n  await app.listen(apiConf.port)\r\n  Logger.log(\r\n    `Application running on: http://localhost:${apiConf.port}/api`,\r\n    'Main'\r\n  )\r\n}\r\nbootstrap()\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u4fdd\u5b58\u67e5\u770b\u6548\u679c"}),"\n",(0,t.jsx)(n.h2,{id:"\u7528\u6237\u6a21\u5757\u6dfb\u52a0",children:"\u7528\u6237\u6a21\u5757\u6dfb\u52a0"}),"\n",(0,t.jsxs)(n.p,{children:["\u521b\u5efa\u597d ",(0,t.jsx)(n.code,{children:"AuthController"}),"\uff0c\u6211\u4eec\u5728\u91cc\u9762\u6dfb\u52a0\u4e24\u4e2a ",(0,t.jsx)(n.code,{children:"Post"})," \u63a5\u53e3\uff0c\u767b\u5f55\u6ce8\u518c\u7684\u903b\u8f91\u540e\u9762\u518d\u5b9e\u73b0\u3002"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",metastring:'title="apps/server/src/modules/user/auth.controller.ts"',children:"import { Controller, Post } from '@nestjs/common'\r\n\r\n@Controller('auth')\r\nexport class AuthController {\r\n  @Post('login')\r\n  login() {\r\n    return 'login success'\r\n  }\r\n\r\n  @Post('register')\r\n  register() {\r\n    return 'register success'\r\n  }\r\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:["\u63a5\u4e0b\u6765\u65b0\u5efa\u4e00\u4e2a ",(0,t.jsx)(n.code,{children:"UserModule"})," \u6a21\u5757\u3002"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",metastring:'title="apps/server/src/modules/user/user.module.ts"',children:"import { Module } from '@nestjs/common'\r\nimport { AuthController } from '@/modules/user/auth.controller'\r\n\r\n@Module({\r\n  controllers: [AuthController]\r\n})\r\nexport class UserModule {}\n"})}),"\n",(0,t.jsxs)(n.p,{children:["\u7136\u540e\u5728 ",(0,t.jsx)(n.code,{children:"AppModule"})," \u91cc\u9762\u5bfc\u5165\u3002"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-tsx",metastring:'title="apps\\server\\src\\app.module.ts"',children:"// ...\r\nimport { UserModule } from '@/modules/user/user.module'\r\n\r\n@Module({\r\n  imports: [\r\n    // ..\r\n    UserModule\r\n  ]\r\n})\r\nexport class AppModule {}\n"})}),"\n",(0,t.jsxs)(n.p,{children:["\u8c03\u7528 login \u63a5\u53e3\u770b\u5230\u6210\u529f\u8fd4\u56de ",(0,t.jsx)(n.code,{children:"login success"}),"\u3002"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:r(2714).A+"",width:"1212",height:"520"})}),"\n",(0,t.jsx)(n.h2,{id:"\u7edf\u4e00\u62e6\u622a\u5668",children:"\u7edf\u4e00\u62e6\u622a\u5668"}),"\n",(0,t.jsx)(n.p,{children:"\u6dfb\u52a0\u4e00\u4e2a\u6253\u5370\u6bcf\u4e2a\u63a5\u53e3\u5904\u7406\u65f6\u95f4\u7684\u62e6\u622a\u5668\u3002"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",metastring:'title="apps/server/src/common/interceptor/process-time.interceptor.ts"',children:"import {\r\n  CallHandler,\r\n  ExecutionContext,\r\n  Injectable,\r\n  NestInterceptor,\r\n  Logger\r\n} from '@nestjs/common'\r\nimport { Observable } from 'rxjs'\r\nimport { tap } from 'rxjs/operators'\r\n\r\n@Injectable()\r\nexport class ProcessTimeInterceptor implements NestInterceptor {\r\n  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {\r\n    const { method, path } = context.switchToHttp().getRequest()\r\n    const now = Date.now()\r\n    return next.handle().pipe(\r\n      tap(() => {\r\n        const useTime = Date.now() - now\r\n        if (useTime > 1000) {\r\n          Logger.warn(\r\n            `processing \\x1B[36m${method} ${path}\\x1B[0m \\x1B[31muse ${useTime}ms\\x1B[0m`,\r\n            ProcessTimeInterceptor.name\r\n          )\r\n        } else {\r\n          Logger.log(\r\n            `processing \\x1B[36m${method} ${path}\\x1B[0m \\x1B[33muse ${useTime}ms\\x1B[0m`,\r\n            ProcessTimeInterceptor.name\r\n          )\r\n        }\r\n      })\r\n    )\r\n  }\r\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u6dfb\u52a0\u4e00\u4e2a\u628a\u6240\u6709\u8fd4\u56de\u7ed3\u679c\u5305\u88c5\u4e00\u4e0b\u7684\u62e6\u622a\u5668\u3002"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",metastring:'title="apps/server/src/common/interceptor/response-wrap.interceptor.ts"',children:"import {\r\n  CallHandler,\r\n  ExecutionContext,\r\n  Injectable,\r\n  NestInterceptor\r\n} from '@nestjs/common'\r\nimport { map } from 'rxjs/operators'\r\nimport { Observable } from 'rxjs'\r\n\r\ntype ResponseWrap<T> = {\r\n  status: number\r\n  data: T\r\n  message: string\r\n}\r\n\r\n@Injectable()\r\nexport class ResponseWrapInterceptor<T> implements NestInterceptor<T> {\r\n  intercept(\r\n    context: ExecutionContext,\r\n    next: CallHandler\r\n  ): Observable<ResponseWrap<T>> {\r\n    return next.handle().pipe(\r\n      map(data => {\r\n        return { status: 0, data, message: 'success' }\r\n      })\r\n    )\r\n  }\r\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:["\u628a\u8fd9\u4e24\u4e2a\u62e6\u622a\u5668\u901a\u8fc7 ",(0,t.jsx)(n.code,{children:"index.ts"})," \u66b4\u9732\u51fa\u53bb\u3002"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",metastring:'title="apps/server/src/common/interceptor/index.ts"',children:"export * from './process-time.interceptor'\r\nexport * from './response-wrap.interceptor'\n"})}),"\n",(0,t.jsxs)(n.p,{children:["\u5728 ",(0,t.jsx)(n.code,{children:"main.ts"})," \u91cc\u4f7f\u7528 ",(0,t.jsx)(n.code,{children:"useGlobalInterceptors"})," \u4f7f\u7528\u8fd9\u4e24\u4e2a\u62e6\u622a\u5668\u3002"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",metastring:'title="apps/server/src/main.ts"',children:"// ...\r\nimport {\r\n  ProcessTimeInterceptor,\r\n  ResponseWrapInterceptor\r\n} from '@/common/interceptor'\r\n// ...\r\nasync function bootstrap() {\r\n  // ...\r\n  app.useGlobalInterceptors(new ProcessTimeInterceptor())\r\n  app.useGlobalInterceptors(new ResponseWrapInterceptor())\r\n  // ..\r\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u518d\u8c03\u7528 login \u63a5\u53e3\u770b\u770b\u770b\u6548\u679c\u3002"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:r(145).A+"",width:"1033",height:"737"})}),"\n",(0,t.jsx)(n.h2,{id:"\u7edf\u4e00\u9519\u8bef\u8fc7\u6ee4\u5668",children:"\u7edf\u4e00\u9519\u8bef\u8fc7\u6ee4\u5668"}),"\n",(0,t.jsx)(n.p,{children:"\u5148\u6dfb\u52a0\u4e00\u4e2a Http \u9519\u8bef\u8fc7\u6ee4\u5668\u3002"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",metastring:'=title="apps/server/src/common/filter/http-exception.filter.ts"',children:"import {\r\n  ArgumentsHost,\r\n  Catch,\r\n  ExceptionFilter,\r\n  HttpException\r\n} from '@nestjs/common'\r\nimport { Request, Response } from 'express'\r\n\r\n@Catch(HttpException)\r\nexport class HttpExceptionFilter implements ExceptionFilter {\r\n  catch(exception: HttpException, host: ArgumentsHost) {\r\n    const ctx = host.switchToHttp()\r\n    const response = ctx.getResponse<Response>()\r\n    const request = ctx.getRequest<Request>()\r\n\r\n    const status = exception.getStatus()\r\n    const exceptionRes = exception.getResponse()\r\n\r\n    const error =\r\n      typeof exceptionRes === 'string'\r\n        ? { message: exceptionRes }\r\n        : (exceptionRes as object)\r\n\r\n    response.status(status).json({\r\n      status,\r\n      timestamp: new Date().toISOString(),\r\n      path: request.url,\r\n      ...error\r\n    })\r\n  }\r\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u518d\u6dfb\u52a0\u4e00\u4e2a\u5176\u4ed6\u9519\u8bef\u7684\u8fc7\u6ee4\u5668\u3002"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",metastring:'=title="apps/server/src/common/filter/other-exception.filter.ts"',children:"import {\r\n  ArgumentsHost,\r\n  Catch,\r\n  ExceptionFilter,\r\n  HttpStatus\r\n} from '@nestjs/common'\r\n\r\n@Catch()\r\nexport class OtherExceptionFilter implements ExceptionFilter {\r\n  catch(exception: any, host: ArgumentsHost) {\r\n    const ctx = host.switchToHttp()\r\n    const response = ctx.getResponse()\r\n    const request = ctx.getRequest()\r\n\r\n    response.status(HttpStatus.INTERNAL_SERVER_ERROR).json({\r\n      status: HttpStatus.INTERNAL_SERVER_ERROR,\r\n      timestamp: new Date().toISOString(),\r\n      path: request.url,\r\n      message: exception.toString()\r\n    })\r\n  }\r\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:["\u8fd9\u4e24\u4e2a\u9519\u8bef\u8fc7\u6ee4\u5668\u6bd4\u539f\u6765\u9ed8\u8ba4\u7684\u6548\u679c\uff0c\u662f\u7edf\u4e00\u52a0\u4e86\u4e00\u4e2a ",(0,t.jsx)(n.code,{children:"timestamp"})," \u548c ",(0,t.jsx)(n.code,{children:"path"})," \u5b57\u6bb5\uff0c\u540e\u9762\u5982\u679c\u8981\u628a\u9519\u8bef\u4e0a\u62a5\u5230\u4e00\u4e9b\u65e5\u5fd7\u5e73\u53f0\u5c31\u5728\u8fd9\u91cc\u9762\u52a0\u903b\u8f91\u5373\u53ef\u3002"]}),"\n",(0,t.jsxs)(n.p,{children:["\u6700\u540e\u628a\u8fd9\u4e24\u4e2a\u9519\u8bef\u8fc7\u6ee4\u5668\u901a\u8fc7 ",(0,t.jsx)(n.code,{children:"index.ts"})," \u66b4\u9732\u51fa\u53bb\u3002"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",metastring:'title="apps/server/src/common/filter/index.ts"',children:"export * from './http-exception.filter'\r\nexport * from './other-exception.filter'\n"})}),"\n",(0,t.jsxs)(n.p,{children:["\u5728 ",(0,t.jsx)(n.code,{children:"main.ts"})," \u91cc\u4f7f\u7528 ",(0,t.jsx)(n.code,{children:"useGlobalFilters"})," \u4f7f\u7528\u8fd9\u4e24\u4e2a\u9519\u8bef\u8fc7\u6ee4\u5668\u3002"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",metastring:'title="apps/server/src/main.ts"',children:"// ...\r\nimport { OtherExceptionFilter, HttpExceptionFilter } from '@/common/filter'\r\n\r\nasync function bootstrap() {\r\n  // ...\r\n  app.useGlobalFilters(new OtherExceptionFilter())\r\n  app.useGlobalFilters(new HttpExceptionFilter())\r\n  // ..\r\n}\r\nbootstrap()\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u6548\u679c\u7684\u8bdd\u81ea\u884c\u52a0\u4e00\u4e9b\u62a5\u9519\u903b\u8f91\u67e5\u770b\u5373\u53ef\uff0c\u672c\u8282\u5c31\u5230\u8fd9\u91cc\u7ed3\u675f\u4e86\u3002"})]})}function d(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(a,{...e})}):a(e)}},2714:(e,n,r)=>{r.d(n,{A:()=>t});const t=r.p+"assets/images/01-843a9c7126ad7eb91b16e6960fb565fc.png"},145:(e,n,r)=>{r.d(n,{A:()=>t});const t=r.p+"assets/images/02-1d5d2cfaf01f7c445ad4879d06a0bb5c.png"},9128:(e,n,r)=>{r.d(n,{R:()=>i,x:()=>c});var t=r(9474);const s={},o=t.createContext(s);function i(e){const n=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),t.createElement(o.Provider,{value:n},e.children)}}}]);