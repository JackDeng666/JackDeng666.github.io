"use strict";(self.webpackChunkying_blog=self.webpackChunkying_blog||[]).push([[1189],{1567:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>a,contentTitle:()=>o,default:()=>p,frontMatter:()=>t,metadata:()=>l,toc:()=>c});var i=r(3274),s=r(9128);const t={id:"user-avatar-and-integrated-minio",sidebar_label:"\u7528\u6237\u5934\u50cf\u548c\u96c6\u6210MinIO",title:"\u7528\u6237\u5934\u50cf\u548c\u96c6\u6210MinIO"},o=void 0,l={id:"ying-chat/user-avatar-and-integrated-minio",title:"\u7528\u6237\u5934\u50cf\u548c\u96c6\u6210MinIO",description:"\u672c\u8282\u6765\u5b9e\u73b0\u7528\u6237\u5934\u50cf\u7684\u529f\u80fd\uff0c\u672c\u5e94\u7528\u5c06\u4f7f\u7528 MinIO \u6765\u5b9e\u73b0\u5e94\u7528\u4ea7\u751f\u7684\u6240\u6709\u9759\u6001\u8d44\u6e90\u7684\u5b58\u50a8\uff0c\u5982\u7528\u6237\u5934\u50cf\u3001\u6d88\u606f\u56fe\u7247\u3001\u89c6\u9891\u7b49\u3002",source:"@site/docs/ying-chat/13-integrated-minio-and-user-avatar.md",sourceDirName:"ying-chat",slug:"/ying-chat/user-avatar-and-integrated-minio",permalink:"/docs/ying-chat/user-avatar-and-integrated-minio",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:13,frontMatter:{id:"user-avatar-and-integrated-minio",sidebar_label:"\u7528\u6237\u5934\u50cf\u548c\u96c6\u6210MinIO",title:"\u7528\u6237\u5934\u50cf\u548c\u96c6\u6210MinIO"},sidebar:"yingChat",previous:{title:"\u4fee\u6539\u7528\u6237\u4fe1\u606f\u529f\u80fd\u6dfb\u52a0",permalink:"/docs/ying-chat/update-userinfo"},next:{title:"\u7fa4\u7ec4\u76f8\u5173api\u5b9e\u73b0",permalink:"/docs/ying-chat/group-api"}},a={},c=[{value:"\u542f\u52a8 MinIO \u5bb9\u5668",id:"\u542f\u52a8-minio-\u5bb9\u5668",level:2},{value:"\u96c6\u6210 MinIO",id:"\u96c6\u6210-minio",level:2},{value:"MinIO \u914d\u7f6e\u521d\u59cb\u5316",id:"minio-\u914d\u7f6e\u521d\u59cb\u5316",level:3},{value:"shared \u5305\u914d\u7f6e",id:"shared-\u5305\u914d\u7f6e",level:3},{value:"\u5b9e\u73b0\u4e0a\u4f20\u6587\u4ef6\u6a21\u5757",id:"\u5b9e\u73b0\u4e0a\u4f20\u6587\u4ef6\u6a21\u5757",level:3},{value:"\u7528\u6237\u4e0a\u4f20\u5934\u50cf\u63a5\u53e3",id:"\u7528\u6237\u4e0a\u4f20\u5934\u50cf\u63a5\u53e3",level:2},{value:"\u52a0\u8f7d\u6587\u4ef6\u65f6\u66f4\u65b0\u6709\u6548\u6587\u4ef6\u5730\u5740",id:"\u52a0\u8f7d\u6587\u4ef6\u65f6\u66f4\u65b0\u6709\u6548\u6587\u4ef6\u5730\u5740",level:2},{value:"\u524d\u7aef\u5bf9\u63a5\u4e0a\u4f20\u7528\u6237\u5934\u50cf",id:"\u524d\u7aef\u5bf9\u63a5\u4e0a\u4f20\u7528\u6237\u5934\u50cf",level:2},{value:"\u56fe\u7247\u4e0a\u4f20\u7ec4\u4ef6\u5c01\u88c5",id:"\u56fe\u7247\u4e0a\u4f20\u7ec4\u4ef6\u5c01\u88c5",level:3},{value:"\u5bf9\u63a5\u4e0a\u4f20\u7528\u6237\u5934\u50cf",id:"\u5bf9\u63a5\u4e0a\u4f20\u7528\u6237\u5934\u50cf",level:3}];function d(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",img:"img",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"\u672c\u8282\u6765\u5b9e\u73b0\u7528\u6237\u5934\u50cf\u7684\u529f\u80fd\uff0c\u672c\u5e94\u7528\u5c06\u4f7f\u7528 MinIO \u6765\u5b9e\u73b0\u5e94\u7528\u4ea7\u751f\u7684\u6240\u6709\u9759\u6001\u8d44\u6e90\u7684\u5b58\u50a8\uff0c\u5982\u7528\u6237\u5934\u50cf\u3001\u6d88\u606f\u56fe\u7247\u3001\u89c6\u9891\u7b49\u3002"}),"\n",(0,i.jsx)(n.p,{children:"\u9996\u5148\u5148\u8ba9\u6211\u4ecb\u7ecd\u4e00\u4e0b MinIO \uff1a\u5b83\u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u5bf9\u8c61\u5b58\u50a8\u670d\u52a1\u5668\uff0c\u5b83\u53ef\u4ee5\u5e2e\u52a9\u4f60\u6784\u5efa\u81ea\u5df1\u7684\u79c1\u6709\u4e91\u5b58\u50a8\u89e3\u51b3\u65b9\u6848\u3002\u5b83\u7684\u8bbe\u8ba1\u76ee\u6807\u662f\u517c\u5bb9 Amazon S3\uff08Simple Storage Service\uff09\uff0c\u8fd9\u610f\u5473\u7740\u4f60\u53ef\u4ee5\u4f7f\u7528\u4e0e S3 \u76f8\u540c\u7684 API \u6765\u7ba1\u7406\u548c\u8bbf\u95ee\u5b58\u50a8\u5728 MinIO \u4e2d\u7684\u5bf9\u8c61\u3002\r\n\u5b83\u7684\u4e3b\u8981\u7528\u9014\u662f\u4f5c\u4e3a\u5bf9\u8c61\u5b58\u50a8\u89e3\u51b3\u65b9\u6848\uff0c\u7528\u4e8e\u5b58\u50a8\u548c\u7ba1\u7406\u5927\u91cf\u7684\u975e\u7ed3\u6784\u5316\u6570\u636e\uff0c\u5982\u56fe\u7247\u3001\u89c6\u9891\u3001\u65e5\u5fd7\u3001\u5907\u4efd\u6587\u4ef6\u7b49\u3002"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://min.io/docs/minio/container/index.html",children:"minio \u542f\u52a8\u6587\u6863"})}),"\n",(0,i.jsx)(n.h2,{id:"\u542f\u52a8-minio-\u5bb9\u5668",children:"\u542f\u52a8 MinIO \u5bb9\u5668"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:'docker run --name minio-test -d \\\r\n  -p 9000:9000 \\\r\n  -p 9090:9090 \\\r\n  -v D:/DockerData/ContainerBackup/minio-data:/data \\\r\n  -e MINIO_ROOT_USER=ying \\\r\n  -e MINIO_ROOT_PASSWORD=ying123456 \\\r\n  minio/minio server /data --console-address ":9090"\n'})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"/data"})," \u662f MinIO \u5bb9\u5668\u5185\u7684\u6570\u636e\u5b58\u50a8\u4f4d\u7f6e"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"--console-address"})," \u662f MinIO \u7684\u540e\u53f0\u7ba1\u7406\u5730\u5740\u7aef\u53e3"]}),"\n",(0,i.jsxs)(n.p,{children:["\u5982\u679c\u662f\u5728 windows \u4e0b\u4f7f\u7528 GitBash \u8dd1\u547d\u4ee4\uff0c\u628a ",(0,i.jsx)(n.code,{children:"/data"})," \u6539\u4e3a ",(0,i.jsx)(n.code,{children:"./data"})," \uff0c\u5426\u5219\u4f1a\u65e0\u6cd5\u6b63\u786e\u4f7f\u7528\u8def\u5f84\u3002"]}),"\n",(0,i.jsxs)(n.p,{children:["\u5982\u679c\u662f\u5728 windows \u4e0b\u4f7f\u7528 cmd \u8dd1\u547d\u4ee4\uff0c\u628a ",(0,i.jsx)(n.code,{children:"\\"})," \u6362\u884c\u7b26\u6539\u4e3a ",(0,i.jsx)(n.code,{children:"^"})," \u5373\u53ef\u3002"]}),"\n",(0,i.jsx)(n.p,{children:"\u542f\u52a8\u5b8c\u6210\u540e\u5373\u53ef\u6253\u5f00 MinIO \u7684\u540e\u53f0\u7ba1\u7406\u7cfb\u7edf"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"http://localhost:9090",children:"http://localhost:9090"})}),"\n",(0,i.jsxs)(n.p,{children:["\u7136\u540e\u5728\u91cc\u9762\u6dfb\u52a0\u4e00\u4e2a ",(0,i.jsx)(n.code,{children:"Access Key"}),"\uff0c\u540e\u9762\u670d\u52a1\u7aef\u8981\u7528\u8fd9\u4e2a",(0,i.jsx)(n.code,{children:"Access Key"}),"\u8fde\u63a5 MinIO\u3002"]}),"\n",(0,i.jsx)(n.h2,{id:"\u96c6\u6210-minio",children:"\u96c6\u6210 MinIO"}),"\n",(0,i.jsx)(n.h3,{id:"minio-\u914d\u7f6e\u521d\u59cb\u5316",children:"MinIO \u914d\u7f6e\u521d\u59cb\u5316"}),"\n",(0,i.jsx)(n.p,{children:"\u5728\u670d\u52a1\u7aef\u4e0b\u6765\u4f9d\u8d56\u3002"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",metastring:'title="apps/server"',children:"pnpm i minio\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://min.io/docs/minio/linux/developers/javascript/API.html",children:"minio \u7684 js \u5e93\u6587\u6863"})}),"\n",(0,i.jsx)(n.p,{children:"\u6dfb\u52a0\u65b0\u7684\u914d\u7f6e"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",metastring:'title="apps/server/.env"',children:"# minio\r\nMINIO_HOST=localhost\r\nMINIO_PORT=9000\r\nMINIO_ACCESS_KEY=Jd86dW5F1aXvfcQroe5e\r\nMINIO_SECRET_KEY=RlQqCWexfztJAQ8A17VS3bdZAj22WhFrWvJBbBQ6\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u65b0\u5efa ",(0,i.jsx)(n.code,{children:"minio.config.ts"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",metastring:'title="apps/server/src/config/minio.config.ts"',children:"import { registerAs } from '@nestjs/config'\r\n\r\nexport const minioConfig = registerAs('minioConfig', () => {\r\n  if (!process.env.MINIO_HOST) {\r\n    throw new Error('MINIO_HOST is not exist')\r\n  }\r\n  if (!process.env.MINIO_PORT) {\r\n    throw new Error('MINIO_PORT is not exist')\r\n  }\r\n  if (!process.env.MINIO_ACCESS_KEY) {\r\n    throw new Error('MINIO_ACCESS_KEY is not exist')\r\n  }\r\n  if (!process.env.MINIO_SECRET_KEY) {\r\n    throw new Error('MINIO_SECRET_KEY is not exist')\r\n  }\r\n  return {\r\n    host: process.env.MINIO_HOST,\r\n    port: +process.env.MINIO_PORT,\r\n    accessKey: process.env.MINIO_ACCESS_KEY,\r\n    secretKey: process.env.MINIO_SECRET_KEY\r\n  }\r\n})\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u522b\u5fd8\u4e86\u5bfc\u51fa"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",metastring:'title="apps/server/src/config/index.ts"',children:"// ...\r\nexport * from './minio.config'\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u8bb0\u5f97\u5728",(0,i.jsx)(n.code,{children:"AppModule"}),"\u91cc\u52a0\u8f7d\u4e00\u4e0b",(0,i.jsx)(n.code,{children:"minioConfig"}),"\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",metastring:'title="apps/server/src/app.module.ts"',children:"import {\r\n  //...\r\n  minioConfig\r\n} from '@/config'\r\n\r\n@Module({\r\n  imports: [\r\n    ConfigModule.forRoot({\r\n      isGlobal: true,\r\n      load: [\r\n        // ...\r\n        minioConfig\r\n      ]\r\n    })\r\n    // ...\r\n  ]\r\n  // ...\r\n})\r\nexport class AppModule {}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"shared-\u5305\u914d\u7f6e",children:"shared \u5305\u914d\u7f6e"}),"\n",(0,i.jsxs)(n.p,{children:["\u5728",(0,i.jsx)(n.code,{children:"shared"}),"\u5305\u65b0\u5efa\u4e00\u4e2a",(0,i.jsx)(n.code,{children:"enum"}),"\u6587\u4ef6\u5939\uff0c\u6dfb\u52a0\u4e00\u4e2a",(0,i.jsx)(n.code,{children:"file.enum.ts"}),"\u6587\u4ef6\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",metastring:'title="packages/shared/src/enum/file.enum.ts"',children:"export enum FileType {\r\n  Avatar,\r\n  Cover,\r\n  Image,\r\n  Video\r\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u65b0\u5efa\u4e00\u4e2a",(0,i.jsx)(n.code,{children:"index.ts"}),"\u5bfc\u51fa\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",metastring:'title="packages/shared/src/enum/index.ts"',children:"export * from './file.enum'\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u5bfc\u51fa\u6574\u4e2a",(0,i.jsx)(n.code,{children:"enum"}),"\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",metastring:'title="packages/shared/src/index.ts"',children:"// ...\r\nexport * from './enum'\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u65b0\u5efa\u4e00\u4e2a",(0,i.jsx)(n.code,{children:"file.vo.ts"}),"\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",metastring:'title="packages/shared/src/vo/file.vo.ts"',children:"import { FileType } from '../enum'\r\n\r\nexport type FileVo = {\r\n  id: number\r\n  name: string\r\n  type: FileType\r\n  url: string\r\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u5bfc\u51fa\u3002"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",metastring:'title="packages/shared/src/vo/index.ts"',children:"// ...\r\nexport * from './file.vo'\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u5b9e\u73b0\u4e0a\u4f20\u6587\u4ef6\u6a21\u5757",children:"\u5b9e\u73b0\u4e0a\u4f20\u6587\u4ef6\u6a21\u5757"}),"\n",(0,i.jsxs)(n.p,{children:["\u6dfb\u52a0\u4e00\u4e2a",(0,i.jsx)(n.code,{children:"FileEntity"}),"\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",metastring:'title="apps/server/src/modules/db/entities/file.entity.ts"',children:"import { Column, Entity, JoinColumn, ManyToOne } from 'typeorm'\r\nimport { FileType } from '@ying-chat/shared'\r\nimport { BaseEntity, UserEntity } from '.'\r\n\r\n@Entity({ name: 'file' })\r\nexport class FileEntity extends BaseEntity {\r\n  @Column({\r\n    length: 50,\r\n    unique: true\r\n  })\r\n  path: string\r\n\r\n  @Column({\r\n    type: 'enum',\r\n    enum: FileType\r\n  })\r\n  type: FileType\r\n\r\n  @Column({\r\n    length: 2083\r\n  })\r\n  url: string\r\n\r\n  @Column()\r\n  createById: number\r\n\r\n  @ManyToOne(() => UserEntity)\r\n  @JoinColumn()\r\n  createBy: UserEntity\r\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u5728",(0,i.jsx)(n.code,{children:"index.ts"}),"\u5bfc\u51fa\u4e00\u4e0b\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",metastring:'title="apps/server/src/modules/db/entities/index.ts"',children:"// ...\r\nexport * from './file.entity'\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u5728",(0,i.jsx)(n.code,{children:"modules"}),"\u4e0b\u65b0\u5efa ",(0,i.jsx)(n.code,{children:"file"})," \u6587\u4ef6\u5939\uff0c\u7136\u540e\u6dfb\u52a0\u4e00\u4e2a ",(0,i.jsx)(n.code,{children:"constant.ts"}),"\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",metastring:'title="apps/server/src/modules/file/constant.ts"',children:"export const MINIO_TOKEN = 'MINIO_CLIENT'\r\n\r\nexport const BUCKET_NAME = 'ying-chat'\r\n\r\nexport const EXPIR_SECONDS = 24 * 60 * 60\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u6dfb\u52a0\u4e00\u4e2a",(0,i.jsx)(n.code,{children:"file.service.ts"}),"\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",metastring:'title="apps/server/src/modules/file/file.service.ts"',children:"import { Inject, Injectable } from '@nestjs/common'\r\nimport { InjectRepository } from '@nestjs/typeorm'\r\nimport { Repository } from 'typeorm'\r\nimport { Client, ItemBucketMetadata } from 'minio'\r\nimport { nanoid } from 'nanoid'\r\nimport { FileType } from '@ying-chat/shared'\r\nimport { FileEntity } from '@/modules/db/entities'\r\nimport { BUCKET_NAME, EXPIR_SECONDS, MINIO_TOKEN } from './constant'\r\n\r\ntype UploadFileOptions = {\r\n  file: Express.Multer.File\r\n  fileType: FileType\r\n  userId: number\r\n  meteData?: ItemBucketMetadata\r\n}\r\n\r\n@Injectable()\r\nexport class FileService {\r\n  @Inject(MINIO_TOKEN)\r\n  private readonly minioClient: Client\r\n\r\n  @InjectRepository(FileEntity)\r\n  private readonly minioFileRepository: Repository<FileEntity>\r\n\r\n  async uploadFile({ file, fileType, userId, meteData }: UploadFileOptions) {\r\n    const fileName = nanoid()\r\n    const objectName = `${fileType}/${fileName}`\r\n\r\n    await this.minioClient.putObject(BUCKET_NAME, objectName, file.buffer, {\r\n      'Content-Type': file.mimetype,\r\n      userId,\r\n      ...meteData\r\n    })\r\n    const url = await this.getPresignedUrl(objectName)\r\n\r\n    const minioFile = this.minioFileRepository.create({\r\n      type: fileType,\r\n      path: objectName,\r\n      url,\r\n      createById: userId\r\n    })\r\n    await this.minioFileRepository.save(minioFile)\r\n\r\n    return minioFile\r\n  }\r\n\r\n  getPresignedUrl(objectName: string) {\r\n    return this.minioClient.presignedUrl(\r\n      'get',\r\n      BUCKET_NAME,\r\n      objectName,\r\n      EXPIR_SECONDS\r\n    )\r\n  }\r\n}\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",metastring:'title="apps/server"',children:"pnpm i -D @types/multer\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u5b89\u88c5\u4e00\u4e0b\u8fd9\u4e2a\u5e93\uff0c\u8fd9\u6837\u5c31\u80fd\u4f7f\u7528",(0,i.jsx)(n.code,{children:"Express.Multer.File"}),"\u8fd9\u4e2a\u7c7b\u578b\u3002"]}),"\n",(0,i.jsxs)(n.p,{children:["\u6dfb\u52a0\u4e00\u4e2a",(0,i.jsx)(n.code,{children:"FileModule"}),"\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",metastring:'title="apps/server/src/modules/file/file.module.ts"',children:"import { Global, Module } from '@nestjs/common'\r\nimport { TypeOrmModule } from '@nestjs/typeorm'\r\nimport { Client } from 'minio'\r\nimport { ConfigType } from '@nestjs/config'\r\nimport { minioConfig } from '@/config'\r\nimport { FileEntity } from '@/modules/db/entities'\r\nimport { FileService } from './file.service'\r\nimport { BUCKET_NAME, MINIO_TOKEN } from './constant'\r\n\r\n@Global()\r\n@Module({\r\n  imports: [TypeOrmModule.forFeature([FileEntity])],\r\n  providers: [\r\n    {\r\n      provide: MINIO_TOKEN,\r\n      async useFactory(minioConf: ConfigType<typeof minioConfig>) {\r\n        const minioClient = new Client({\r\n          endPoint: minioConf.host,\r\n          port: minioConf.port,\r\n          useSSL: false,\r\n          accessKey: minioConf.accessKey,\r\n          secretKey: minioConf.secretKey\r\n        })\r\n        const bucketExists = await minioClient.bucketExists(BUCKET_NAME)\r\n        if (!bucketExists) {\r\n          minioClient.makeBucket(BUCKET_NAME)\r\n        }\r\n        return minioClient\r\n      },\r\n      inject: [minioConfig.KEY]\r\n    },\r\n    FileService\r\n  ],\r\n  exports: [FileService]\r\n})\r\nexport class FileModule {}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u8bb0\u5f97\u5728",(0,i.jsx)(n.code,{children:"AppModule"}),"\u91cc\u52a0\u8f7d\u4e00\u4e0b",(0,i.jsx)(n.code,{children:"FileModule"}),"\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",metastring:'title="apps/server/src/app.module.ts"',children:"// ...\r\nimport { FileModule } from '@/modules/file/file.module'\r\n\r\n@Module({\r\n  imports: [\r\n    // ...\r\n    FileModule\r\n  ]\r\n  // ...\r\n})\r\nexport class AppModule {}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"\u7528\u6237\u4e0a\u4f20\u5934\u50cf\u63a5\u53e3",children:"\u7528\u6237\u4e0a\u4f20\u5934\u50cf\u63a5\u53e3"}),"\n",(0,i.jsx)(n.p,{children:"\u63a5\u4e0b\u6765\u5c31\u53ef\u4ee5\u5b9e\u73b0\u7528\u6237\u4e0a\u4f20\u5934\u50cf\u7684\u63a5\u53e3\u4e86\u3002"}),"\n",(0,i.jsxs)(n.p,{children:["\u5148\u4fee\u6539\u4e00\u4e0b",(0,i.jsx)(n.code,{children:"UserEntity"}),"\uff0c\u628a\u7528\u6237\u8868\u548c\u6587\u4ef6\u8868\u5173\u8054\u8d77\u6765\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",metastring:'title="apps/server/src/modules/db/entities/user.entity.ts"',children:"// ...\r\nimport {\r\n  // ...\r\n  JoinColumn,\r\n  OneToOne\r\n} from 'typeorm'\r\nimport { FileEntity } from './file.entity'\r\n\r\n@Entity({ name: 'user' })\r\nexport class UserEntity extends BaseEntity {\r\n  // ...\r\n\r\n  @Column({\r\n    nullable: true\r\n  })\r\n  avatarId: number\r\n\r\n  @OneToOne(() => FileEntity)\r\n  @JoinColumn()\r\n  avatar: FileEntity\r\n\r\n  // ...\r\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u4fee\u6539\u4e00\u4e0b",(0,i.jsx)(n.code,{children:"UserService"}),"\u7684",(0,i.jsx)(n.code,{children:"getUserInfo"}),"\u51fd\u6570\uff0c\u518d\u6dfb\u52a0\u4e00\u4e2a",(0,i.jsx)(n.code,{children:"uploadUserAvatar"}),"\u51fd\u6570\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",metastring:'title="apps/server/src/modules/user/user.service.ts"',children:"// ...\r\nimport {\r\n  // ...\r\n  Inject\r\n} from '@nestjs/common'\r\nimport {\r\n  // ...\r\n  FileType\r\n} from '@ying-chat/shared'\r\nimport { FileService } from '@/modules/file/file.service'\r\n\r\n@Injectable()\r\nexport class UserService {\r\n  // ...\r\n\r\n  @Inject()\r\n  private readonly fileService: FileService\r\n\r\n  async getUserInfo(userId: number) {\r\n    const user = await this.userRepository.findOne({\r\n      where: { id: userId },\r\n      relations: ['avatar'] // +\r\n    })\r\n\r\n    // ...\r\n  }\r\n\r\n  // ...\r\n\r\n  async uploadUserAvatar(file: Express.Multer.File, userId: number) {\r\n    const minioFile = await this.fileService.uploadFile({\r\n      file,\r\n      fileType: FileType.Avatar,\r\n      userId\r\n    })\r\n\r\n    await this.userRepository.update({ id: userId }, { avatarId: minioFile.id })\r\n\r\n    return minioFile\r\n  }\r\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u6dfb\u52a0\u4e0a\u4f20\u5934\u50cf\u63a5\u53e3\u3002"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",metastring:'title="apps/server/src/modules/user/user.controller.ts"',children:"// ...\r\nimport {\r\n  FileTypeValidator,\r\n  MaxFileSizeValidator,\r\n  ParseFilePipe,\r\n  UploadedFile,\r\n  UseInterceptors\r\n} from '@nestjs/common'\r\nimport { FileInterceptor } from '@nestjs/platform-express'\r\n\r\n@ApiTags('user')\r\n@Controller('user')\r\nexport class UserController {\r\n  // ...\r\n\r\n  @ApiOperation({\r\n    summary: 'uploadUserAvatar'\r\n  })\r\n  @Post('avatar')\r\n  @UseInterceptors(FileInterceptor('file'))\r\n  uploadUserAvatar(\r\n    @Req() req: Request,\r\n    @UploadedFile(\r\n      new ParseFilePipe({\r\n        validators: [\r\n          new MaxFileSizeValidator({\r\n            maxSize: 5 * 1024 * 1024,\r\n            message: 'size must less than 5MB'\r\n          }),\r\n          new FileTypeValidator({ fileType: /image\\/(png|jpeg|jpg)/ })\r\n        ]\r\n      })\r\n    )\r\n    file: Express.Multer.File\r\n  ) {\r\n    return this.userService.uploadUserAvatar(file, req.userId)\r\n  }\r\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"\u52a0\u8f7d\u6587\u4ef6\u65f6\u66f4\u65b0\u6709\u6548\u6587\u4ef6\u5730\u5740",children:"\u52a0\u8f7d\u6587\u4ef6\u65f6\u66f4\u65b0\u6709\u6548\u6587\u4ef6\u5730\u5740"}),"\n",(0,i.jsx)(n.p,{children:"\u6211\u4eec\u524d\u9762\u4e0a\u4f20\u6587\u4ef6\u5230 MinIO \u65f6\uff0c\u90fd\u9884\u7b7e\u4e86\u4e00\u4e2a 24 \u5c0f\u65f6\u8fc7\u671f\u7684\u6587\u4ef6\u5730\u5740\u5b58\u8fdb\u6570\u636e\u5e93\uff0c\u73b0\u5728\u8981\u4f7f\u8fd9\u4e2a\u6587\u4ef6\u5728\u52a0\u8f7d\u65f6\uff0c\u91cd\u65b0\u83b7\u53d6\u65b0\u7684\u9884\u7b7e\u5730\u5740\u3002"}),"\n",(0,i.jsxs)(n.p,{children:["\u6dfb\u52a0\u4e00\u4e2a",(0,i.jsx)(n.code,{children:"MinioFileSubscriber"}),"\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",metastring:'title="apps/server/src/modules/file/file.subscriber.ts"',children:"import { Inject } from '@nestjs/common'\r\nimport {\r\n  DataSource,\r\n  EntitySubscriberInterface,\r\n  EventSubscriber,\r\n  Repository\r\n} from 'typeorm'\r\nimport { InjectRepository } from '@nestjs/typeorm'\r\nimport { Client } from 'minio'\r\nimport {\r\n  BUCKET_NAME,\r\n  EXPIR_SECONDS,\r\n  MINIO_TOKEN\r\n} from '@/modules/file/constant'\r\nimport { FileEntity } from '@/modules/db/entities'\r\n\r\n@EventSubscriber()\r\nexport class FileSubscriber implements EntitySubscriberInterface<FileEntity> {\r\n  constructor(\r\n    dataSource: DataSource,\r\n    @Inject(MINIO_TOKEN)\r\n    private readonly minioClient: Client,\r\n    @InjectRepository(FileEntity)\r\n    private readonly minioFileRepository: Repository<FileEntity>\r\n  ) {\r\n    dataSource.subscribers.push(this)\r\n  }\r\n\r\n  listenTo() {\r\n    return FileEntity\r\n  }\r\n\r\n  async afterLoad(entity: FileEntity) {\r\n    try {\r\n      if (\r\n        Date.now() - new Date(entity.updateAt).getTime() >\r\n        EXPIR_SECONDS * 1000\r\n      ) {\r\n        const newUrl = await this.minioClient.presignedUrl(\r\n          'get',\r\n          BUCKET_NAME,\r\n          entity.path,\r\n          EXPIR_SECONDS\r\n        )\r\n        entity.url = newUrl\r\n        this.minioFileRepository.update({ id: entity.id }, { url: newUrl })\r\n      }\r\n    } catch (error) {\r\n      console.error(error)\r\n    }\r\n  }\r\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u5728",(0,i.jsx)(n.code,{children:"FileModule"}),"\u91cc\u52a0\u8f7d\u4e00\u4e0b\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",metastring:'title="apps/server/src/modules/file/file.module.ts"',children:"//...\r\nimport { FileSubscriber } from './file.subscriber'\r\n\r\n@Global()\r\n@Module({\r\n  // ...\r\n  providers: [\r\n    // ...\r\n    FileSubscriber\r\n  ]\r\n  // ...\r\n})\r\nexport class FileModule {}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"\u524d\u7aef\u5bf9\u63a5\u4e0a\u4f20\u7528\u6237\u5934\u50cf",children:"\u524d\u7aef\u5bf9\u63a5\u4e0a\u4f20\u7528\u6237\u5934\u50cf"}),"\n",(0,i.jsx)(n.p,{children:"\u5728\u7528\u6237 api \u6dfb\u52a0\u4e00\u4e2a\u4e0a\u4f20\u63a5\u53e3\u3002"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",metastring:'title="apps/client/src/api/user.ts"',children:"// ...\r\nimport {\r\n  // ...\r\n  FileVo\r\n} from '@ying-chat/shared'\r\n\r\nexport function uploadUserAvatar(file: File): Promise<FileVo> {\r\n  const form = new FormData()\r\n  form.append('file', file)\r\n  return request.post('/user/avatar', form)\r\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u56fe\u7247\u4e0a\u4f20\u7ec4\u4ef6\u5c01\u88c5",children:"\u56fe\u7247\u4e0a\u4f20\u7ec4\u4ef6\u5c01\u88c5"}),"\n",(0,i.jsxs)(n.p,{children:["\u5728",(0,i.jsx)(n.code,{children:"components"}),"\u6dfb\u52a0\u4e00\u4e2a",(0,i.jsx)(n.code,{children:"upload"}),"\u6587\u4ef6\u5939\uff0c\u7136\u540e\u6dfb\u52a0\u4e00\u4e2a",(0,i.jsx)(n.code,{children:"useUpload"})," hook\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",metastring:'title="apps/client/src/components/upload/use-upload.ts"',children:"import { useState } from 'react'\r\n\r\nexport enum SelectFileType {\r\n  Image,\r\n  Video\r\n}\r\n\r\nexport const selectFile: (type?: SelectFileType) => Promise<File> = type => {\r\n  return new Promise(resolve => {\r\n    const input = document.createElement('input')\r\n    input.type = 'file'\r\n\r\n    if (type === SelectFileType.Image) {\r\n      input.accept = 'image/png,image/jpeg,image/jpg'\r\n    } else if (type === SelectFileType.Video) {\r\n      input.accept = 'video/mp4'\r\n    }\r\n\r\n    input.multiple = false\r\n\r\n    input.onchange = async () => {\r\n      const file = input.files?.[0]\r\n      if (file) {\r\n        resolve(file)\r\n      }\r\n    }\r\n\r\n    input.click()\r\n  })\r\n}\r\n\r\ntype UseUploadOptions<T> = {\r\n  handleUpload: (file: File) => Promise<T>\r\n  onSuccess?: (res: T) => void\r\n}\r\n\r\nexport const useUpload = <T>({\r\n  handleUpload,\r\n  onSuccess\r\n}: UseUploadOptions<T>) => {\r\n  const [loading, setLoading] = useState(false)\r\n\r\n  const start = (type?: SelectFileType) => {\r\n    selectFile(type).then(async file => {\r\n      try {\r\n        setLoading(true)\r\n        if (handleUpload) {\r\n          const res = await handleUpload(file)\r\n          onSuccess && onSuccess(res)\r\n        }\r\n      } catch {\r\n      } finally {\r\n        setLoading(false)\r\n      }\r\n    })\r\n  }\r\n\r\n  return {\r\n    start,\r\n    loading\r\n  }\r\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u518d\u5199\u4e00\u4e2a",(0,i.jsx)(n.code,{children:"ImageUpload"}),"\u7ec4\u4ef6\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tsx",metastring:'title="apps/client/src/components/upload/image-upload.tsx"',children:"import { useState } from 'react'\r\nimport { Plus } from 'lucide-react'\r\nimport { CircularProgress, cn } from '@nextui-org/react'\r\nimport { FileVo } from '@ying-chat/shared'\r\nimport { SelectFileType, useUpload } from './use-upload'\r\n\r\ntype MinioUploadProps = {\r\n  handleUpload: (file: File) => Promise<FileVo>\r\n  defaultUrl?: string\r\n  onSuccess?: (file: FileVo) => void\r\n}\r\n\r\nexport const ImageUpload = ({\r\n  defaultUrl,\r\n  onSuccess,\r\n  handleUpload\r\n}: MinioUploadProps) => {\r\n  const [url, setUrl] = useState(defaultUrl)\r\n\r\n  const { loading, start } = useUpload({\r\n    handleUpload,\r\n    onSuccess: minioFile => {\r\n      setUrl(minioFile.url)\r\n      onSuccess && onSuccess(minioFile)\r\n    }\r\n  })\r\n\r\n  return (\r\n    <div\r\n      className=\"inline-block w-[110px] h-[110px] cursor-pointer\"\r\n      onClick={() => {\r\n        start(SelectFileType.Image)\r\n      }}\r\n    >\r\n      {url ? (\r\n        <img className=\"w-full h-full rounded-full object-cover\" src={url} />\r\n      ) : (\r\n        <div\r\n          className={cn(\r\n            'w-full h-full rounded-full border-dashed text-2xl fc border-2',\r\n            'bg-content2 text-foreground-500 border-foreground-500'\r\n          )}\r\n        >\r\n          {loading ? <CircularProgress /> : <Plus />}\r\n        </div>\r\n      )}\r\n    </div>\r\n  )\r\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u65b0\u5efa\u4e00\u4e2a",(0,i.jsx)(n.code,{children:"index.ts"}),"\u628a\u8fd9\u4e24\u4e2a\u5bfc\u51fa\u4e00\u4e0b\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",metastring:'title="apps/client/src/components/upload/index.ts"',children:"export * from './image-upload'\r\nexport * from './use-upload'\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u5bf9\u63a5\u4e0a\u4f20\u7528\u6237\u5934\u50cf",children:"\u5bf9\u63a5\u4e0a\u4f20\u7528\u6237\u5934\u50cf"}),"\n",(0,i.jsxs)(n.p,{children:["\u4fee\u6539\u4e00\u4e0b",(0,i.jsx)(n.code,{children:"UserInfoModal"}),"\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tsx",metastring:'title="apps\\client\\src\\components\\modals\\user-info-modal.tsx"',children:"// ...\r\nimport { ImageUpload } from '@/components/upload'\r\nimport { setUserInfo, useAuthStore } from '@/stores'\r\n\r\n// ...\r\n\r\nexport const UserInfoModal = ({\r\n  open,\r\n  close,\r\n  confirmSuccess,\r\n  initialValues\r\n}: UserInfoModalProps) => {\r\n  //...\r\n\r\n  const userInfo = useAuthStore(state => state.userInfo)\r\n\r\n  return (\r\n    {/*  */}\r\n    <ModalBody>\r\n      {/*  */}\r\n      <div className=\"flex flex-col items-center gap-3\">\r\n        <p>User Avatar</p>\r\n        <ImageUpload\r\n          defaultUrl={userInfo?.avatar?.url}\r\n          handleUpload={file => userApi.uploadUserAvatar(file)}\r\n          onSuccess={res => {\r\n            setUserInfo({\r\n              ...userInfo!,\r\n              avatar: res\r\n            })\r\n          }}\r\n        />\r\n      </div>\r\n    </ModalBody>\r\n    {/*  */}\r\n  )\r\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u8fd9\u65f6\u5019\u4f1a\u53d1\u73b0",(0,i.jsx)(n.code,{children:"userInfo"}),"\u4f1a\u62a5\u7ea2\uff0c\u63d0\u793a\u7c7b\u578b\u201cUserVo\u201d\u4e0a\u4e0d\u5b58\u5728\u5c5e\u6027\u201cavatar\u201d\uff0c\u6211\u4eec\u5230",(0,i.jsx)(n.code,{children:"shared"}),"\u5305\u91cc\u52a0\u4e00\u4e0b\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",metastring:'title="packages/shared/src/vo/user.vo.ts"',children:"import { FileVo } from './file.vo'\r\n\r\nexport type UserVo = {\r\n  // ...\r\n  avatarId?: number\r\n  avatar?: FileVo\r\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u8fd9\u65f6\u5019\u5c31\u4e0d\u4f1a\u62a5\u9519\u4e86\u3002"}),"\n",(0,i.jsxs)(n.p,{children:["\u6700\u540e\u5728",(0,i.jsx)(n.code,{children:"NavSidebar"}),"\u4e5f\u52a0\u4e0a\u7528\u6237\u5934\u50cf\uff0c\u987a\u4fbf\u52a0\u4e0a\u6bcf\u6b21\u52a0\u8f7d\u65f6\u81ea\u52a8\u83b7\u53d6\u4e00\u4e0b\u6700\u65b0\u4fe1\u606f\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tsx",metastring:'title="apps\\client\\src\\components\\layout\\nav-sidebar.tsx"',children:"// ...\r\nimport {\r\n  // ...\r\n  useEffect\r\n} from 'react'\r\n\r\nexport const NavSidebar = () => {\r\n  // ...\r\n\r\n  useEffect(() => {\r\n    getUserInfo()\r\n  }, [])\r\n\r\n  return (\r\n    {/*  */}\r\n    <Avatar\r\n      className=\"cursor-pointer h-[48px] w-[48px]\"\r\n      src={userInfo?.avatar?.url}\r\n    />\r\n    {/*  */}\r\n  )\r\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u6d4b\u8bd5\u4e00\u4e0b\u3002"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:r(7259).A+"",width:"1920",height:"1080"})}),"\n",(0,i.jsx)(n.p,{children:"\u672c\u8282\u5230\u6b64\u7ed3\u675f\u3002"})]})}function p(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},7259:(e,n,r)=>{r.d(n,{A:()=>i});const i=r.p+"assets/images/01-a33618b2d2b3a5bb19af3ab71f3db5d2.gif"},9128:(e,n,r)=>{r.d(n,{R:()=>o,x:()=>l});var i=r(9474);const s={},t=i.createContext(s);function o(e){const n=i.useContext(t);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);