"use strict";(self.webpackChunkying_blog=self.webpackChunkying_blog||[]).push([[7046],{9395:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>i,default:()=>l,frontMatter:()=>c,metadata:()=>o,toc:()=>a});var t=r(3274),s=r(9128);const c={id:"docker-build-deploy",sidebar_label:"\u4f7f\u7528docker\u6253\u5305\u6574\u4e2a\u5e94\u7528\u90e8\u7f72",title:"\u4f7f\u7528docker\u6253\u5305\u6574\u4e2a\u5e94\u7528\u90e8\u7f72"},i=void 0,o={id:"ying-chat/docker-build-deploy",title:"\u4f7f\u7528docker\u6253\u5305\u6574\u4e2a\u5e94\u7528\u90e8\u7f72",description:"\u672c\u8282\u6765\u4f7f\u7528 docker \u6253\u5305\u6574\u4e2a\u5e94\u7528\u90e8\u7f72\u3002",source:"@site/docs/ying-chat/21-docker-build-deploy.md",sourceDirName:"ying-chat",slug:"/ying-chat/docker-build-deploy",permalink:"/docs/ying-chat/docker-build-deploy",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:21,frontMatter:{id:"docker-build-deploy",sidebar_label:"\u4f7f\u7528docker\u6253\u5305\u6574\u4e2a\u5e94\u7528\u90e8\u7f72",title:"\u4f7f\u7528docker\u6253\u5305\u6574\u4e2a\u5e94\u7528\u90e8\u7f72"},sidebar:"yingChat",previous:{title:"\u5ba2\u6237\u7aef\u5bf9\u63a5\u5373\u65f6\u901a\u8baf",permalink:"/docs/ying-chat/docking-realtime-message"}},d={},a=[{value:"\u9879\u76ee\u51c6\u5907",id:"\u9879\u76ee\u51c6\u5907",level:3},{value:"docker \u51c6\u5907",id:"docker-\u51c6\u5907",level:3}];function p(e){const n={code:"code",h3:"h3",img:"img",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.p,{children:"\u672c\u8282\u6765\u4f7f\u7528 docker \u6253\u5305\u6574\u4e2a\u5e94\u7528\u90e8\u7f72\u3002"}),"\n",(0,t.jsx)(n.h3,{id:"\u9879\u76ee\u51c6\u5907",children:"\u9879\u76ee\u51c6\u5907"}),"\n",(0,t.jsx)(n.p,{children:"\u56e0\u4e3a\u6700\u7ec8\u8981\u628a\u524d\u7aef\u5e94\u7528\u6253\u5305\u7684\u4ee3\u7801\u653e\u5230 server \u7aef\u8fd0\u884c\uff0c\u6240\u4ee5\u8fd8\u9700\u8981\u4fee\u6539\u4e00\u4e0b\u4ee3\u7801\u3002"}),"\n",(0,t.jsxs)(n.p,{children:["\u5728",(0,t.jsx)(n.code,{children:"main.ts"}),"\u4f7f\u7528",(0,t.jsx)(n.code,{children:"useStaticAssets"}),"\u8bbe\u7f6e server \u9879\u76ee\u4e0b",(0,t.jsx)(n.code,{children:"public"}),"\u6587\u4ef6\u5939\u4e3a\u9759\u6001\u6587\u4ef6\u3002"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",metastring:'title="apps/server/src/main.ts"',children:"// ...\r\nimport { NestExpressApplication } from '@nestjs/platform-express'\r\n\r\nasync function bootstrap() {\r\n  const app = await NestFactory.create<NestExpressApplication>(AppModule)\r\n  // ...\r\n  app.useStaticAssets('public')\r\n  // ...\r\n}\r\nbootstrap()\n"})}),"\n",(0,t.jsxs)(n.p,{children:["\u4fee\u6539\u4e00\u4e0b",(0,t.jsx)(n.code,{children:"HttpExceptionFilter"}),"\uff0c\u5224\u65ad 404 \u65f6\u5982\u679c\u8def\u7531\u524d\u7f00\u4e0d\u662f",(0,t.jsx)(n.code,{children:"/api"}),"\u5219\u8fd4\u56de",(0,t.jsx)(n.code,{children:"public"}),"\u7684",(0,t.jsx)(n.code,{children:"index.html"}),"\u6587\u4ef6\uff0c\u8fd9\u6837\u76f4\u63a5\u5237\u65b0\u524d\u7aef\u9875\u9762\u65f6\u5c31\u4e0d\u4f1a\u62a5 404 \u4e86\u3002"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",metastring:'title="apps/server/src/common/filter/http-exception.filter.ts"',children:"import {\r\n  // ...\r\n  HttpStatus\r\n} from '@nestjs/common'\r\n// ...\r\nimport { createReadStream } from 'fs'\r\nimport { join } from 'path'\r\n\r\n@Catch(HttpException)\r\nexport class HttpExceptionFilter implements ExceptionFilter {\r\n  catch(exception: HttpException, host: ArgumentsHost) {\r\n    // ...\r\n\r\n    if (\r\n      status === HttpStatus.NOT_FOUND &&\r\n      !request.url.startsWith('/api') &&\r\n      process.env.NODE_ENV === 'prod'\r\n    ) {\r\n      const indexFile = createReadStream(\r\n        join(process.cwd(), 'public/index.html')\r\n      )\r\n      indexFile.pipe(response)\r\n      return\r\n    }\r\n\r\n    // ...\r\n  }\r\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"docker-\u51c6\u5907",children:"docker \u51c6\u5907"}),"\n",(0,t.jsxs)(n.p,{children:["\u6839\u76ee\u5f55\u6dfb\u52a0\u4e00\u4e2a",(0,t.jsx)(n.code,{children:".dockerignore"}),"\u6587\u4ef6\u3002"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",metastring:'title=".dockerignore"',children:".git\r\n.gitignore\r\n*.md\r\n**/node_modules\r\n**/dist\r\n**/public\r\n.vscode\r\n.husky\r\n.dockerignore\r\nDockerfile\r\n.eslintignore\r\n.eslintrc\r\n.prettierrc\r\n.prettierignore\n"})}),"\n",(0,t.jsxs)(n.p,{children:["\u6dfb\u52a0",(0,t.jsx)(n.code,{children:"Dockerfile"}),"\u914d\u7f6e\u6587\u4ef6\u3002"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-dockerfile",metastring:'title="Dockerfile"',children:'FROM node:18-alpine3.14\r\n\r\nRUN npm i pnpm@8 -g\r\nRUN npm i pm2@5 -g\r\n\r\nWORKDIR /app\r\n\r\nCOPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./\r\n\r\nCOPY packages/shared/package.json packages/shared/package.json\r\nCOPY apps/client/package.json apps/client/package.json\r\nCOPY apps/server/package.json apps/server/package.json\r\n\r\nRUN pnpm i\r\n\r\nCOPY . .\r\n\r\nRUN pnpm -r build && cp -r /app/apps/client/dist/ /app/apps/server/public/\r\n\r\nWORKDIR /app/apps/server\r\n\r\nENV NODE_ENV prod\r\nENV SERVER_PORT 3000\r\nEXPOSE 3000\r\n\r\nCMD ["pm2-runtime", "start", "dist/main.js"]\n'})}),"\n",(0,t.jsx)(n.p,{children:"\u76f4\u63a5\u6839\u76ee\u5f55\u6253\u5305\u5373\u53ef"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",metastring:'title="/"',children:"docker build -t ying-chat:latest .\n"})}),"\n",(0,t.jsxs)(n.p,{children:["\u6253\u5305\u5b8c\u6210\u540e\u542f\u52a8\u5bb9\u5668\uff0c\u81ea\u884c\u586b\u5165\u5404\u4e2a\u914d\u7f6e\u9879\uff0c",(0,t.jsx)(n.code,{children:"kubernetes.docker.internal"}),"\u4e3a\u5bb9\u5668\u8bbf\u95ee\u6211 windows \u7684\u672c\u5730\u7f51\u7edc\u3002"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:"docker run --name ying-chat \\\r\n  -p 80:3000 \\\r\n  -e SERVER_PORT=3000 \\\r\n  -e SERVER_JWT_SECRET=4h4gdsf2ds1f2 \\\r\n  -e EMAIl_HOST=smtp.qq.com \\\r\n  -e EMAIL_PORT=465 \\\r\n  -e EMAIL_USER=jackdeng155@qq.com \\\r\n  -e EMAIL_AUTH_CODE=somjvruefdgbided \\\r\n  -e DB_HOST=kubernetes.docker.internal \\\r\n  -e DB_USER=root \\\r\n  -e DB_PORT=3306 \\\r\n  -e DB_PASSWORD=ying123456 \\\r\n  -e DB_NAME=ying_chat \\\r\n  -e REDIS_HOST=kubernetes.docker.internal \\\r\n  -e REDIS_PORT=6379 \\\r\n  -e MINIO_HOST=kubernetes.docker.internal \\\r\n  -e MINIO_PORT=9000 \\\r\n  -e MINIO_ACCESS_KEY=Jd86dW5F1aXvfcQroe5e \\\r\n  -e MINIO_SECRET_KEY=RlQqCWexfztJAQ8A17VS3bdZAj22WhFrWvJBbBQ6 \\\r\n  -d ying-chat:latest\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u770b\u770b\u6548\u679c\u3002"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:r(3226).A+"",width:"1920",height:"1080"})}),"\n",(0,t.jsx)(n.p,{children:"\u672c\u8282\u5230\u6b64\u7ed3\u675f\u3002"})]})}function l(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(p,{...e})}):p(e)}},3226:(e,n,r)=>{r.d(n,{A:()=>t});const t=r.p+"assets/images/01-3aac63c3090f1d0d6d40b9f33ae296b2.gif"},9128:(e,n,r)=>{r.d(n,{R:()=>i,x:()=>o});var t=r(9474);const s={},c=t.createContext(s);function i(e){const n=t.useContext(c);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),t.createElement(c.Provider,{value:n},e.children)}}}]);