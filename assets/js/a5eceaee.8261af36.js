"use strict";(self.webpackChunkying_blog=self.webpackChunkying_blog||[]).push([[8865],{9333:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>i,contentTitle:()=>a,default:()=>p,frontMatter:()=>o,metadata:()=>c,toc:()=>l});var t=n(3274),s=n(9128);const o={id:"preview-component-and-router-cache",sidebar_label:"\u9884\u89c8\u7ec4\u4ef6\u548c\u8def\u7531\u7f13\u5b58",title:"\u9884\u89c8\u7ec4\u4ef6\u548c\u8def\u7531\u7f13\u5b58"},a=void 0,c={id:"ying-chat/preview-component-and-router-cache",title:"\u9884\u89c8\u7ec4\u4ef6\u548c\u8def\u7531\u7f13\u5b58",description:"\u672c\u8282\u6765\u5b9e\u73b0\u56fe\u7247\u548c\u89c6\u9891\u9884\u89c8\u7ec4\u4ef6\u548c\u8def\u7531\u7684\u7f13\u5b58\u3002",source:"@site/docs/ying-chat/18-preview-component-and-router-cache.md",sourceDirName:"ying-chat",slug:"/ying-chat/preview-component-and-router-cache",permalink:"/docs/ying-chat/preview-component-and-router-cache",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:18,frontMatter:{id:"preview-component-and-router-cache",sidebar_label:"\u9884\u89c8\u7ec4\u4ef6\u548c\u8def\u7531\u7f13\u5b58",title:"\u9884\u89c8\u7ec4\u4ef6\u548c\u8def\u7531\u7f13\u5b58"},sidebar:"yingChat",previous:{title:"\u5ba2\u6237\u7aef\u5bf9\u63a5\u7fa4\u804aapi",permalink:"/docs/ying-chat/docking-message-api"},next:{title:"\u4f7f\u7528socket.io\u5b9e\u73b0\u5373\u65f6\u901a\u8baf",permalink:"/docs/ying-chat/realtime-message-and-socket.io"}},i={},l=[{value:"\u56fe\u7247\u548c\u89c6\u9891\u9884\u89c8\u7ec4\u4ef6",id:"\u56fe\u7247\u548c\u89c6\u9891\u9884\u89c8\u7ec4\u4ef6",level:2},{value:"\u7ec4\u4ef6\u51c6\u5907",id:"\u7ec4\u4ef6\u51c6\u5907",level:3},{value:"\u4f7f\u7528",id:"\u4f7f\u7528",level:3},{value:"\u8def\u7531\u7f13\u5b58\u6dfb\u52a0",id:"\u8def\u7531\u7f13\u5b58\u6dfb\u52a0",level:2},{value:"react-router \u7684\u7f13\u5b58",id:"react-router-\u7684\u7f13\u5b58",level:3},{value:"\u4f1a\u8bdd\u548c\u7fa4\u8be6\u60c5\u9875\u9762\u7f13\u5b58",id:"\u4f1a\u8bdd\u548c\u7fa4\u8be6\u60c5\u9875\u9762\u7f13\u5b58",level:3}];function d(e){const r={code:"code",h2:"h2",h3:"h3",img:"img",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(r.p,{children:"\u672c\u8282\u6765\u5b9e\u73b0\u56fe\u7247\u548c\u89c6\u9891\u9884\u89c8\u7ec4\u4ef6\u548c\u8def\u7531\u7684\u7f13\u5b58\u3002"}),"\n",(0,t.jsx)(r.h2,{id:"\u56fe\u7247\u548c\u89c6\u9891\u9884\u89c8\u7ec4\u4ef6",children:"\u56fe\u7247\u548c\u89c6\u9891\u9884\u89c8\u7ec4\u4ef6"}),"\n",(0,t.jsx)(r.h3,{id:"\u7ec4\u4ef6\u51c6\u5907",children:"\u7ec4\u4ef6\u51c6\u5907"}),"\n",(0,t.jsxs)(r.p,{children:["\u5728",(0,t.jsx)(r.code,{children:"stores"}),"\u6587\u4ef6\u5939\u91cc\u6dfb\u52a0",(0,t.jsx)(r.code,{children:"use-preview-store.ts"}),"\u3002"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-ts",metastring:'title="apps/client/src/stores/use-preview-store.ts"',children:"import { create } from 'zustand'\r\n\r\ntype PreviewType = 'image' | 'video'\r\n\r\ntype PreviewStore = {\r\n  type: PreviewType\r\n  url: string\r\n  open: boolean\r\n}\r\n\r\nexport const usePreview = create<PreviewStore>(() => ({\r\n  type: 'image',\r\n  url: '',\r\n  open: false\r\n}))\r\n\r\nexport const openPreview = (type: PreviewType, url: string) => {\r\n  usePreview.setState({ open: true, type, url })\r\n}\r\n\r\nexport const closePreview = () => {\r\n  usePreview.setState({ open: false })\r\n}\n"})}),"\n",(0,t.jsx)(r.p,{children:"\u5bfc\u51fa\u4e00\u4e0b\u3002"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-ts",metastring:'title="apps/client/src/stores/index.ts"',children:"// ...\r\nexport * from './use-preview-store'\n"})}),"\n",(0,t.jsxs)(r.p,{children:["\u5728",(0,t.jsx)(r.code,{children:"components"}),"\u91cc\u9762\u76f4\u63a5\u6dfb\u52a0",(0,t.jsx)(r.code,{children:"PreviewModal"}),"\u3002"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-tsx",metastring:'title="apps/client/src/components/preview-modal.tsx"',children:'import { Modal, ModalContent } from \'@nextui-org/react\'\r\nimport { usePreview, closePreview } from \'@/stores\'\r\n\r\nexport const PreviewModal = () => {\r\n  const { open, url, type } = usePreview()\r\n\r\n  return (\r\n    <Modal\r\n      isOpen={open}\r\n      onClose={() => closePreview()}\r\n      className="bg-transparent"\r\n      size="full"\r\n      classNames={{ closeButton: \'top-5 right-5\' }}\r\n    >\r\n      <ModalContent className="fc">\r\n        {type === \'image\' ? (\r\n          <img src={url} className="max-w-full h-[80%] object-cover" />\r\n        ) : (\r\n          <video className="max-w-full h-[80%]" src={url} controls autoPlay />\r\n        )}\r\n      </ModalContent>\r\n    </Modal>\r\n  )\r\n}\n'})}),"\n",(0,t.jsx)(r.h3,{id:"\u4f7f\u7528",children:"\u4f7f\u7528"}),"\n",(0,t.jsxs)(r.p,{children:["\u5728",(0,t.jsx)(r.code,{children:"App.tsx"}),"\u91cc\u4f7f\u7528",(0,t.jsx)(r.code,{children:"PreviewModal"}),"\u3002"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-tsx",metastring:'title="apps/client/src/App.tsx"',children:'// ...\r\nimport { PreviewModal } from \'@/components/preview-modal\'\r\n\r\nfunction App() {\r\n  return (\r\n    <ThemeProvider defaultTheme="dark">\r\n      <Toaster richColors position="top-center" />\r\n      <PreviewModal />\r\n      <RouterProvider router={router}></RouterProvider>\r\n    </ThemeProvider>\r\n  )\r\n}\r\n\r\nexport default App\n'})}),"\n",(0,t.jsxs)(r.p,{children:["\u5728",(0,t.jsx)(r.code,{children:"message-item.tsx"}),"\u91cc\u4f7f\u7528",(0,t.jsx)(r.code,{children:"openPreview"}),"\u3002"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-tsx",metastring:'title="apps/client/src/pages/conversation/messages/message-item.tsx"',children:"// ...\r\nimport {\r\n  // ...\r\n  openPreview\r\n} from '@/stores'\r\n\r\nconst MessageItem = memo(\r\n  forwardRef<HTMLDivElement, ChatMessageItemProps>(\r\n    ({ message }, messageItemRef) => {\r\n      // ...\r\n\r\n      return (\r\n        {/*  */}\r\n        {message.type === GroupMessageType.Image && (\r\n          <Image\r\n            src={message.file?.url}\r\n            className=\"w-auto h-[200px] cursor-pointer\"\r\n            onClick={() => openPreview('image', message.file!.url)}\r\n          />\r\n        )}\r\n\r\n        {message.type === GroupMessageType.Video && (\r\n          <Image\r\n            className=\"w-auto h-[200px] cursor-pointer\"\r\n            src={message.cover?.url}\r\n            onClick={() => openPreview('video', message.file!.url)}\r\n          />\r\n        )}\r\n        {/*  */}\r\n      )\r\n    }\r\n  ),\r\n  (prevProps, nextProps) => {\r\n    return prevProps.message.id === nextProps.message.id\r\n  }\r\n)\r\n// ...\n"})}),"\n",(0,t.jsx)(r.p,{children:"\u6d4b\u8bd5\u4e00\u4e0b\u3002"}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.img,{src:n(8058).A+"",width:"1920",height:"1080"})}),"\n",(0,t.jsx)(r.h2,{id:"\u8def\u7531\u7f13\u5b58\u6dfb\u52a0",children:"\u8def\u7531\u7f13\u5b58\u6dfb\u52a0"}),"\n",(0,t.jsx)(r.h3,{id:"react-router-\u7684\u7f13\u5b58",children:"react-router \u7684\u7f13\u5b58"}),"\n",(0,t.jsx)(r.p,{children:"\u5148\u5b89\u88c5\u4e00\u4e0b\u4f9d\u8d56\u3002"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-shell",metastring:'title="apps/client"',children:"pnpm i react-freeze\n"})}),"\n",(0,t.jsxs)(r.p,{children:["\u6dfb\u52a0\u4e00\u4e2a",(0,t.jsx)(r.code,{children:"KeepAliveOutlet"}),"\u3002"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-tsx",metastring:'title="apps/client/src/router/keep-alive.tsx"',children:"import { ReactElement, useContext, useRef } from 'react'\r\nimport { Freeze } from 'react-freeze'\r\nimport { UNSAFE_RouteContext as RouteContext } from 'react-router-dom'\r\n\r\nexport const KeepAliveOutlet = () => {\r\n  const caches = useRef<Record<string, ReactElement>>({})\r\n\r\n  const routeContext = useContext(RouteContext)\r\n  const matchedElement = routeContext.outlet\r\n  const matchedPath = matchedElement?.props?.match?.pathname\r\n\r\n  if (matchedElement && matchedPath) {\r\n    caches.current[matchedPath] = matchedElement\r\n  }\r\n\r\n  return (\r\n    <>\r\n      {Object.entries(caches.current).map(([path, element]) => (\r\n        <Freeze key={path} freeze={element !== matchedElement}>\r\n          {element}\r\n        </Freeze>\r\n      ))}\r\n    </>\r\n  )\r\n}\n"})}),"\n",(0,t.jsxs)(r.p,{children:["\u628a\u5148\u524d\u4f7f\u7528\u7684",(0,t.jsx)(r.code,{children:"react-router-dom"}),"\u7684",(0,t.jsx)(r.code,{children:"Outlet"}),"\u5168\u90e8\u6362\u6210",(0,t.jsx)(r.code,{children:"KeepAliveOutlet"}),"\u3002"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-tsx",metastring:'title="apps/client/src/components/layout/index.tsx"',children:'// ...\r\nimport { KeepAliveOutlet } from \'@/router/keep-alive\'\r\n\r\nexport const AppLayout = () => {\r\n  return useAuthRoute(\r\n    <div className="h-full flex flex-row">\r\n      <NavSidebar />\r\n\r\n      <main className="h-full flex-1">\r\n        <KeepAliveOutlet />\r\n      </main>\r\n    </div>\r\n  )\r\n}\n'})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-tsx",metastring:'title="apps/client/src/pages/contact/index.tsx"',children:'import { KeepAliveOutlet } from \'@/router/keep-alive\'\r\n// ...\r\n\r\nexport const ContactPage = () => {\r\n  return (\r\n    <div className="h-full flex flex-row">\r\n      <Sidebar />\r\n\r\n      <main className="flex-1">\r\n        <KeepAliveOutlet />\r\n      </main>\r\n    </div>\r\n  )\r\n}\n'})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-tsx",metastring:'title="apps/client/src/pages/conversation/index.tsx"',children:'import { KeepAliveOutlet } from \'@/router/keep-alive\'\r\n// ...\r\n\r\nexport const ConversationPage = () => {\r\n  return (\r\n    <ConversationProvider>\r\n      <div className="h-full flex flex-row">\r\n        <Sidebar />\r\n\r\n        <main className="flex-1">\r\n          <KeepAliveOutlet />\r\n        </main>\r\n      </div>\r\n    </ConversationProvider>\r\n  )\r\n}\n'})}),"\n",(0,t.jsx)(r.p,{children:"\u6d4b\u8bd5\u4e00\u4e0b\u3002"}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.img,{src:n(6005).A+"",width:"1920",height:"1080"})}),"\n",(0,t.jsx)(r.h3,{id:"\u4f1a\u8bdd\u548c\u7fa4\u8be6\u60c5\u9875\u9762\u7f13\u5b58",children:"\u4f1a\u8bdd\u548c\u7fa4\u8be6\u60c5\u9875\u9762\u7f13\u5b58"}),"\n",(0,t.jsxs)(r.p,{children:["\u867d\u7136\u8def\u7531\u9875\u9762\u7684\u7f13\u5b58\u6dfb\u52a0\u4e0a\u4e86\uff0c\u4f46\u662f\u70b9\u51fb",(0,t.jsx)(r.code,{children:"NavSidebar"}),"\u7684\u8df3\u8f6c\u4e0d\u4f1a\u8bb0\u5f55\u4e0a\u6b21\u8bbf\u95ee\u7684\u9875\u9762\uff0c\u63a5\u4e0b\u6765\u5728\u5168\u5c40\u72b6\u6001\u91cc\u6dfb\u52a0\u4e00\u4e0b\u3002"]}),"\n",(0,t.jsxs)(r.p,{children:["\u4fee\u6539\u4e00\u4e0b",(0,t.jsx)(r.code,{children:"router"}),"\u4e0b\u7684",(0,t.jsx)(r.code,{children:"index.tsx"}),"\u3002"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-tsx",metastring:'title="apps/client/src/router/index.tsx"',children:"import { createContext, useEffect } from 'react'\r\nimport { useLocation, useRoutes } from 'react-router-dom'\r\nimport { routes } from './routes'\r\n\r\ntype keyType = '/contact' | '/conversation'\r\ntype CacheType = Record<keyType, string>\r\n\r\nconst routeKeyCache: CacheType = {\r\n  '/contact': '/contact',\r\n  '/conversation': '/conversation'\r\n}\r\n\r\nconst setRouteKeyCache = (key: keyType, value: string) => {\r\n  routeKeyCache[key] = value\r\n}\r\n\r\ntype RouterContextType = {\r\n  routeKeyCache: CacheType\r\n}\r\n\r\nexport const RouterContext = createContext<RouterContextType>({\r\n  routeKeyCache\r\n})\r\n\r\nexport const RouterProvider = () => {\r\n  const routesElements = useRoutes(routes)\r\n  const { pathname } = useLocation()\r\n\r\n  useEffect(() => {\r\n    if (pathname.startsWith('/contact')) {\r\n      setRouteKeyCache('/contact', pathname)\r\n    }\r\n\r\n    if (pathname.startsWith('/conversation')) {\r\n      setRouteKeyCache('/conversation', pathname)\r\n    }\r\n  }, [pathname])\r\n\r\n  return (\r\n    <RouterContext.Provider\r\n      value={{\r\n        routeKeyCache\r\n      }}\r\n    >\r\n      {routesElements}\r\n    </RouterContext.Provider>\r\n  )\r\n}\n"})}),"\n",(0,t.jsxs)(r.p,{children:["\u518d\u6dfb\u52a0\u4e00\u4e2a",(0,t.jsx)(r.code,{children:"useRouterContext"}),"\u3002"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-ts",metastring:'title="apps/client/src/router/use-router-context.ts"',children:"import { useContext } from 'react'\r\nimport { RouterContext } from '.'\r\n\r\nexport const useRouterContext = () => {\r\n  return useContext(RouterContext)\r\n}\n"})}),"\n",(0,t.jsxs)(r.p,{children:["\u6539\u53d8\u4e00\u4e0b\u8def\u7531\u7684\u5f15\u5165\u65b9\u5f0f\uff0c\u4fee\u6539",(0,t.jsx)(r.code,{children:"App.tsx"}),"\u3002"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-tsx",metastring:'title="apps/client/src/App.tsx"',children:"import { BrowserRouter } from 'react-router-dom'\r\nimport { RouterProvider } from '@/router'\r\n// ...\r\n\r\nfunction App() {\r\n  return (\r\n    <ThemeProvider defaultTheme=\"dark\">\r\n      <Toaster richColors position=\"top-center\" />\r\n      <PreviewModal />\r\n      <BrowserRouter>\r\n        <RouterProvider />\r\n      </BrowserRouter>\r\n    </ThemeProvider>\r\n  )\r\n}\r\n\r\nexport default App\n"})}),"\n",(0,t.jsxs)(r.p,{children:["\u6700\u540e\u4fee\u6539\u4e00\u4e0b",(0,t.jsx)(r.code,{children:"NavSidebar"}),"\u3002"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-tsx",metastring:'title="apps/client/src/components/layout/nav-sidebar.tsx"',children:"// ...\r\nimport { useRouterContext } from '@/router/use-router-context'\r\n\r\nexport const NavSidebar = () => {\r\n  // ...\r\n  const { routeKeyCache } = useRouterContext()\r\n\r\n  // ...\r\n\r\n  return (\r\n    <div className=\"flex flex-col gap-4 items-center w-[72px] py-4 bg-content1\">\r\n      <div className=\"flex-1 flex flex-col gap-2\">\r\n        <div\r\n          className={cn(\r\n            `fc text-xl w-[48px] h-[48px] cursor-pointer rounded-full transition-all duration-700`,\r\n            'hover:rounded-2xl text-foreground bg-default',\r\n            pathname.startsWith('/conversation') && 'rounded-2xl bg-primary'\r\n          )}\r\n          onClick={() => {\r\n            const cacheRoute = routeKeyCache['/conversation']\r\n            if (cacheRoute) {\r\n              navigate(cacheRoute, { replace: true })\r\n            } else {\r\n              navigate('/conversation', { replace: true })\r\n            }\r\n          }}\r\n        >\r\n          <MessageSquare />\r\n        </div>\r\n        <div\r\n          className={cn(\r\n            `fc text-xl w-[48px] h-[48px] cursor-pointer rounded-full transition-all duration-700`,\r\n            'hover:rounded-2xl text-foreground bg-default',\r\n            pathname.startsWith('/contact') && 'rounded-2xl bg-primary'\r\n          )}\r\n          onClick={() => {\r\n            const cacheRoute = routeKeyCache['/contact']\r\n            if (cacheRoute) {\r\n              navigate(cacheRoute, { replace: true })\r\n            } else {\r\n              navigate('/contact', { replace: true })\r\n            }\r\n          }}\r\n        >\r\n          <Users />\r\n        </div>\r\n      </div>\r\n      {/*  */}\r\n    </div>\r\n  )\r\n}\n"})}),"\n",(0,t.jsx)(r.p,{children:"\u7fa4\u8be6\u60c5\u9875\u9762\u8fd8\u6709\u4e00\u4e2a\u70b9\u51fb\u4e8b\u4ef6\u672a\u6dfb\u52a0\uff0c\u987a\u4fbf\u52a0\u4e00\u4e0b\u3002"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-tsx",metastring:'title="apps/client/src/pages/contact/contact-detail.tsx"',children:'// ...\r\nimport {\r\n  // ...\r\n  useNavigate\r\n} from \'react-router-dom\'\r\n// ...\r\n\r\nexport const ContactDetail = () => {\r\n  // ...\r\n  const navigate = useNavigate()\r\n  // ...\r\n\r\n  const Detail = () => {\r\n    // ...\r\n\r\n    return (\r\n      <div className="w-[50%] h-[50%]">\r\n        <div className="flex items-center">\r\n          {/*  */}\r\n          <Button\r\n            color="primary"\r\n            isIconOnly\r\n            className="rounded-full w-16 h-16"\r\n            onClick={() => {\r\n              navigate(`/conversation/group/${data.id}`)\r\n            }}\r\n          >\r\n            <MessageSquare size={30} />\r\n          </Button>\r\n        </div>\r\n\r\n        {/*  */}\r\n      </div>\r\n    )\r\n  }\r\n\r\n  // ...\r\n}\n'})}),"\n",(0,t.jsx)(r.p,{children:"\u6574\u4f53\u6d4b\u8bd5\u4e00\u4e0b\u3002"}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.img,{src:n(2204).A+"",width:"1920",height:"1080"})}),"\n",(0,t.jsx)(r.p,{children:"\u90a3\u4e48\u672c\u8282\u5230\u6b64\u7ed3\u675f\u3002"})]})}function p(e={}){const{wrapper:r}={...(0,s.R)(),...e.components};return r?(0,t.jsx)(r,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},8058:(e,r,n)=>{n.d(r,{A:()=>t});const t=n.p+"assets/images/01-552103d215a79309db75db40874820de.gif"},6005:(e,r,n)=>{n.d(r,{A:()=>t});const t=n.p+"assets/images/02-e17b24f4f1c61280820d144d6e857820.gif"},2204:(e,r,n)=>{n.d(r,{A:()=>t});const t=n.p+"assets/images/03-3a74a6ea00a2b749925f36fd38a7bba1.gif"},9128:(e,r,n)=>{n.d(r,{R:()=>a,x:()=>c});var t=n(9474);const s={},o=t.createContext(s);function a(e){const r=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function c(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),t.createElement(o.Provider,{value:r},e.children)}}}]);